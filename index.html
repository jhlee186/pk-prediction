<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²”ìš© In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }
        .header h1 { font-size: 26px; margin-bottom: 8px; }
        .content { padding: 30px; }
        .section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 16px; }
        .section h2 { font-size: 16px; margin-bottom: 12px; color: #1f2937; font-weight: 600; }
        .section h3 { font-size: 14px; margin-bottom: 8px; color: #4b5563; font-weight: 600; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .form-group label .req { color: #ef4444; }
        .form-group label .opt { color: #10b981; font-weight: 400; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
        .form-group textarea { min-height: 60px; font-family: monospace; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-secondary { background: #10b981; color: white; }
        .alert { padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid; font-size: 12px; line-height: 1.6; }
        .alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
        .alert-warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .alert-error { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .compound-item { background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 12px; }
        .chart-container { height: 500px; margin-top: 16px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 16px; }
        .comparison-table th, .comparison-table td { padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .comparison-table th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .color-indicator { width: 16px; height: 16px; border-radius: 4px; display: inline-block; }
        .step-indicator { display: flex; justify-content: center; gap: 16px; margin-bottom: 24px; }
        .step { padding: 8px 16px; border-radius: 16px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 13px; }
        .step.active { background: #4f46e5; color: white; }
        .info-box { background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; }
        .help-box { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px; font-size: 11px; margin-top: 4px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .route-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .route-btn { padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.3s; }
        .route-btn:hover { border-color: #4f46e5; }
        .route-btn.selected { border-color: #4f46e5; background: #eff6ff; color: #4f46e5; }
        .collapsible { cursor: pointer; padding: 12px; background: #e5e7eb; border-radius: 6px; margin-bottom: 8px; font-weight: 600; font-size: 13px; }
        .collapsible:hover { background: #d1d5db; }
        .collapsible-content { display: none; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 12px; }
        .collapsible-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ§¬ ë²”ìš© In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ</h1>
                <p style="font-size: 13px;">Salt Form ë¹„êµ ë¶„ì„ | ëª¨ë“  í™”í•©ë¬¼ ì ìš© ê°€ëŠ¥</p>
            </div>

            <div class="content">
                <div class="step-indicator">
                    <div class="step active" id="step1">1ï¸âƒ£ ë¬¼ì§ˆ ì…ë ¥</div>
                    <div class="step" id="step2">2ï¸âƒ£ ì¢… ì„¤ì •</div>
                    <div class="step" id="step3">3ï¸âƒ£ ê²°ê³¼ ë¶„ì„</div>
                </div>
                <div id="alerts"></div>
                <div id="main-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1, compounds = [], selectedSpecies = 'mouse', chartInstance = null, alerts = [];
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
        
        const speciesSettings = {
            mouse: { bodyWeight: 0.025, Vd: 4.0, CL: 60, ka: 1.5, label: 'ğŸ­ Mouse' },
            rat: { bodyWeight: 0.25, Vd: 3.5, CL: 50, ka: 1.2, label: 'ğŸ€ Rat' },
            dog: { bodyWeight: 10, Vd: 2.0, CL: 25, ka: 0.8, label: 'ğŸ• Dog (Beagle)' }
        };

        const formulationDB = {
            'water': { label: 'ì •ì œìˆ˜', viscosity: 1, solFactor: 1.0, kaFactor: 1.0 },
            '0.5% MC': { label: '0.5% MC', viscosity: 50, solFactor: 1.3, kaFactor: 0.85 },
            '0.5% MC 4000cP': { label: '0.5% MC (4000 cP)', viscosity: 4000, solFactor: 1.5, kaFactor: 0.7 },
            '0.2% Tween80 in 0.5% MC': { label: '0.2% Tween 80 in 0.5% MC', viscosity: 3800, solFactor: 2.8, kaFactor: 0.75 },
            '0.5% CMC': { label: '0.5% CMC', viscosity: 100, solFactor: 1.4, kaFactor: 0.8 },
            '1% Tween80': { label: '1% Tween 80', viscosity: 5, solFactor: 3.5, kaFactor: 0.95 },
            'PEG400 30%': { label: '30% PEG 400', viscosity: 50, solFactor: 4.5, kaFactor: 1.0 },
            'custom': { label: 'ì§ì ‘ ì…ë ¥', viscosity: 1, solFactor: 1.0, kaFactor: 1.0 }
        };

        function addAlert(type, msg) { alerts.push({ type, msg }); renderAlerts(); }
        function clearAlerts() { alerts = []; renderAlerts(); }
        function renderAlerts() {
            document.getElementById('alerts').innerHTML = alerts.map(a => 
                `<div class="alert alert-${a.type}"><strong>${a.type === 'success' ? 'âœ…' : a.type === 'error' ? 'âŒ' : a.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</strong> ${a.msg}</div>`
            ).join('');
        }

        function addCompound() {
            compounds.push({
                id: Date.now(),
                name: `ë¬¼ì§ˆ ${compounds.length + 1}`,
                
                // í•„ìˆ˜ í•­ëª©
                route: 'PO',
                dose: '10',
                molecularWeight: '',
                pKa: '',
                logP: '',
                
                // Salt form (ììœ  ì…ë ¥)
                saltForm: 'Free base',
                saltMW: '',
                
                // ìš©í•´ë„
                solubility: { pH1_2: '', pH4_5: '', pH6_8: '', faSSIF: '', faSSGF: '', feSSIF: '', water: '' },
                
                // ADME
                papp: '',
                caco2: '',
                permeability: 'medium',
                proteinBinding: '',
                fu: '',
                hepClearance: '',
                bloodPlasmaRatio: '',
                
                // ì œí˜•
                formulation: '0.2% Tween80 in 0.5% MC',
                customFormulation: '',
                
                // ê³ ê¸‰ (ì„ íƒ)
                particleSize_D50: '',
                particleSize_D90: '',
                crystallinity: 'crystalline',
                dissolutionTest: '',
                pgpSubstrate: 'unknown',
                
                pkResult: null,
                color: colors[compounds.length % colors.length]
            });
            render();
        }

        function removeCompound(id) { compounds = compounds.filter(c => c.id !== id); render(); }
        
        function updateCompound(id, field, subfield, value) {
            const c = compounds.find(c => c.id === id);
            if (!c) return;
            if (subfield) c[field][subfield] = value;
            else c[field] = value;
        }

        // ==================== ê³ ê¸‰ PK ê³„ì‚° (ë²”ìš©) ====================
        function calculatePK(compound) {
            const species = selectedSpecies;
            const settings = speciesSettings[species];
            const route = compound.route;
            
            // 1. ê¸°ë³¸ ë¬¼ì„±
            const mw = parseFloat(compound.molecularWeight);
            const logP = parseFloat(compound.logP) || 2.5;
            const pKa = parseFloat(compound.pKa);
            const dose = parseFloat(compound.dose);
            
            if (!mw || !dose) {
                addAlert('error', `${compound.name}: ë¶„ìëŸ‰ê³¼ ìš©ëŸ‰ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                return false;
            }
            
            // 2. Salt correction
            const saltMW = parseFloat(compound.saltMW) || 0;
            const freebaseMW = mw - saltMW;
            const mwCorrection = freebaseMW / mw;
            const effectiveDose = dose * mwCorrection;
            
            // 3. ìš©í•´ë„ ê³„ì‚° (pH ì˜ì¡´ì )
            const baseSol_pH1_2 = parseFloat(compound.solubility.pH1_2 || compound.solubility.faSSGF) || 1;
            const baseSol_pH6_8 = parseFloat(compound.solubility.pH6_8 || compound.solubility.faSSIF) || 1;
            
            // Henderson-Hasselbalch ê¸°ë°˜ ionization
            let ionizationFactor_gastric = 1.0;
            let ionizationFactor_intestinal = 1.0;
            
            if (pKa) {
                // Base compound (ì•½ì—¼ê¸°)
                if (pKa > 7) {
                    ionizationFactor_gastric = 1 / (1 + Math.pow(10, 1.2 - pKa)); // pH 1.2
                    ionizationFactor_intestinal = 1 / (1 + Math.pow(10, 6.8 - pKa)); // pH 6.8
                } 
                // Acid compound (ì•½ì‚°)
                else {
                    ionizationFactor_gastric = 1 / (1 + Math.pow(10, pKa - 1.2));
                    ionizationFactor_intestinal = 1 / (1 + Math.pow(10, pKa - 6.8));
                }
            }
            
            // Salt supersaturation effect
            let supersaturationRatio = 1.0;
            if (compound.saltForm !== 'Free base' && saltMW > 0) {
                supersaturationRatio = 3.0 + (saltMW / freebaseMW) * 5.0; // ê²½í—˜ì‹
            }
            
            // ë¶€í˜•ì œ íš¨ê³¼
            const formEffect = formulationDB[compound.formulation] || formulationDB.water;
            
            const effectiveSol_intestinal = baseSol_pH6_8 * 
                                           ionizationFactor_intestinal * 
                                           supersaturationRatio * 
                                           formEffect.solFactor;
            
            // 4. íˆ¬ê³¼ë„ ê¸°ë°˜ í¡ìˆ˜ìœ¨
            let papp = parseFloat(compound.papp);
            if (!papp && compound.caco2) papp = parseFloat(compound.caco2);
            if (!papp) {
                if (compound.permeability === 'high') papp = 20;
                else if (compound.permeability === 'medium') papp = 8;
                else papp = 2;
            }
            
            // Dissolution-limited vs Permeability-limited
            const solubilityLimited = Math.min(1, (effectiveSol_intestinal * 15) / (mw * 0.03));
            const permeabilityLimited = Math.min(1, papp / 10);
            
            // ì…ìí¬ê¸° íš¨ê³¼
            const particleSize = parseFloat(compound.particleSize_D50) || 50; // Î¼m
            const particleEffect = Math.sqrt(50 / particleSize); // Noyes-Whitney
            
            let Fa = solubilityLimited * permeabilityLimited * particleEffect;
            
            // ê²°ì •í˜• íš¨ê³¼
            if (compound.crystallinity === 'amorphous') Fa = Fa * 1.5;
            
            // 5. ì´ˆíšŒí†µê³¼ íš¨ê³¼
            const hepCL = parseFloat(compound.hepClearance) || settings.CL * 0.4;
            const Fg = 0.92; // ì¥ë²½
            const Fh = 1 - (hepCL / (hepCL + settings.CL * 1.5)); // ê°„
            
            // P-gp íš¨ê³¼
            let pgpFactor = 1.0;
            if (compound.pgpSubstrate === 'yes') pgpFactor = 0.6;
            
            // 6. ê²½ë¡œë³„ ìƒì²´ì´ìš©ë¥ 
            let F;
            if (route === 'IV') F = 1.0;
            else if (route === 'PO') F = Fa * Fg * Fh * pgpFactor;
            else if (route === 'SC') F = 0.85 * Fa;
            else if (route === 'IP') F = 0.9 * Fa * Fh;
            else if (route === 'IM') F = 0.9 * Fa;
            else F = Fa * Fg * Fh;
            
            F = Math.min(0.98, F);
            
            // 7. PK íŒŒë¼ë¯¸í„°
            const fu = parseFloat(compound.fu) || 
                      (compound.proteinBinding ? (100 - parseFloat(compound.proteinBinding)) / 100 : 0.05);
            const bloodPlasmaRatio = parseFloat(compound.bloodPlasmaRatio) || 1.0;
            
            const Vd = (settings.Vd * (1 + logP * 0.5) / Math.max(fu, 0.01)) * bloodPlasmaRatio;
            const CL = (settings.CL * (400 / mw) * 0.75) + (hepCL * 0.25);
            
            let ka = settings.ka * formEffect.kaFactor;
            if (route === 'IV') ka = 99;
            else if (route === 'SC') ka = ka * 0.6;
            else if (route === 'IM') ka = ka * 0.7;
            
            const ke = (CL * 60) / (Vd * 1000);
            
            // 8. ì‹œê°„ë³„ ë†ë„ (Precipitation ê³ ë ¤)
            const timePoints = [];
            for (let t = 0; t <= 24; t += 0.5) {
                let conc;
                
                if (route === 'IV') {
                    conc = (F * effectiveDose * 1000 / (Vd * settings.bodyWeight)) * Math.exp(-ke * t);
                } else {
                    conc = (F * effectiveDose * 1000 / (Vd * settings.bodyWeight)) * 
                           (ka / (ka - ke)) * (Math.exp(-ke * t) - Math.exp(-ka * t));
                }
                
                // Supersaturation decay (ì¹¨ì „)
                if (supersaturationRatio > 1 && t > 0.5) {
                    const decayFactor = 1 - ((supersaturationRatio - 1) / supersaturationRatio) * 
                                       (1 - Math.exp(-t / 2));
                    conc = conc * Math.max(0.5, decayFactor);
                }
                
                timePoints.push({ time: t, concentration: Math.max(0, conc) });
            }
            
            // 9. AUC, Cmax, Tmax
            let auc = 0;
            for (let i = 1; i < timePoints.length; i++) {
                auc += (timePoints[i].concentration + timePoints[i-1].concentration) / 2 * 0.5;
            }
            
            const Cmax = Math.max(...timePoints.map(p => p.concentration));
            const Tmax = timePoints.find(p => p.concentration === Cmax)?.time || 0;
            
            compound.pkResult = {
                profile: timePoints,
                params: {
                    Cmax: Cmax.toFixed(2),
                    Tmax: Tmax.toFixed(1),
                    AUC: auc.toFixed(2),
                    Vd: Vd.toFixed(2),
                    CL: CL.toFixed(2),
                    t_half: (0.693 / ke).toFixed(2),
                    F: (F * 100).toFixed(1),
                    Fa: (Fa * 100).toFixed(1),
                    ka: ka.toFixed(3),
                    ke: ke.toFixed(3)
                }
            };
            
            return true;
        }

        function calculateAll() {
            clearAlerts();
            let success = 0, fail = 0;
            for (let c of compounds) {
                if (calculatePK(c)) success++;
                else fail++;
            }
            if (success > 0) addAlert('success', `âœ… ${success}ê°œ ë¬¼ì§ˆ ê³„ì‚° ì™„ë£Œ!`);
            if (fail > 0) addAlert('error', `âŒ ${fail}ê°œ ë¬¼ì§ˆ ê³„ì‚° ì‹¤íŒ¨`);
        }

        function validateStep1() {
            clearAlerts();
            if (compounds.length === 0) {
                addAlert('warning', 'ìµœì†Œ 1ê°œ ë¬¼ì§ˆì„ ì¶”ê°€í•˜ì„¸ìš”.');
                return false;
            }
            
            for (let c of compounds) {
                if (!c.molecularWeight) {
                    addAlert('error', `${c.name}: ë¶„ìëŸ‰ í•„ìˆ˜`);
                    return false;
                }
                if (!c.dose) {
                    addAlert('error', `${c.name}: íˆ¬ì—¬ ìš©ëŸ‰ í•„ìˆ˜`);
                    return false;
                }
                const solCount = Object.values(c.solubility).filter(v => v !== '').length;
                if (solCount === 0) {
                    addAlert('error', `${c.name}: ìµœì†Œ 1ê°œ ìš©í•´ë„ ì…ë ¥`);
                    return false;
                }
            }
            return true;
        }

        function updateStepIndicator() {
            ['step1', 'step2', 'step3'].forEach((id, idx) => {
                document.getElementById(id).className = 'step' + (currentStep === idx + 1 ? ' active' : '');
            });
        }

        function nextStep() {
            if (currentStep === 1 && !validateStep1()) return;
            if (currentStep < 3) currentStep++;
            if (currentStep === 3) calculateAll();
            render();
        }

        function prevStep() { if (currentStep > 1) currentStep--; render(); }

        function toggleCollapsible(id) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
        }

        function renderStep1() {
            return `
                <div class="info-box">
                    <strong>ğŸ“Œ í•„ìˆ˜ ì…ë ¥ í•­ëª©</strong><br>
                    âœ“ ë¶„ìëŸ‰, ìš©ëŸ‰, ìš©í•´ë„ (ìµœì†Œ 1ê°œ), íˆ¬ì—¬ê²½ë¡œ<br>
                    <strong>ğŸ¯ ê¶Œì¥ ì…ë ¥ (ì •í™•ë„ â†‘)</strong><br>
                    âœ“ pKa (ê°€ì¥ ì¤‘ìš”!), Papp, LogP, ê°„ CL, ì…ìí¬ê¸°
                </div>

                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2 style="font-size: 16px;">ë“±ë¡ ë¬¼ì§ˆ: ${compounds.length}ê°œ</h2>
                    <button class="btn btn-secondary" onclick="addCompound()" style="padding: 8px 16px;">â• ë¬¼ì§ˆ ì¶”ê°€</button>
                </div>

                ${compounds.length === 0 ? '<div class="alert alert-info">ë¬¼ì§ˆì„ ì¶”ê°€í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</div>' : ''}

                ${compounds.map(c => `
                    <div class="compound-item">
                        <div class="flex-between" style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="color-indicator" style="background: ${c.color};"></div>
                                <input type="text" value="${c.name}" onchange="updateCompound(${c.id}, 'name', null, this.value); render();"
                                       style="font-weight: 600; border: 1px solid #e5e7eb; padding: 6px 10px; border-radius: 6px; width: 250px; font-size: 14px;">
                            </div>
                            <button onclick="removeCompound(${c.id}); render();" 
                                    style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </div>

                        <!-- í•„ìˆ˜ ì„¹ì…˜ -->
                        <div class="section">
                            <h2>ğŸ¯ í•„ìˆ˜ í•­ëª©</h2>
                            
                            <h3 style="margin-top: 12px;">ğŸ’Š íˆ¬ì—¬ ê²½ë¡œ</h3>
                            <div class="route-grid">
                                ${['PO', 'IV', 'SC', 'IP', 'IM'].map(route => `
                                    <div class="route-btn ${c.route === route ? 'selected' : ''}"
                                         onclick="updateCompound(${c.id}, 'route', null, '${route}'); render();">