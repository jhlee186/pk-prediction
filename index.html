<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²”ìš© In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }
        .header h1 { font-size: 26px; margin-bottom: 8px; }
        .content { padding: 30px; }
        .section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 16px; }
        .section h2 { font-size: 16px; margin-bottom: 12px; color: #1f2937; font-weight: 600; }
        .section h3 { font-size: 14px; margin-bottom: 8px; color: #4b5563; font-weight: 600; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .form-group label .req { color: #ef4444; }
        .form-group label .opt { color: #10b981; font-weight: 400; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
        .form-group textarea { min-height: 60px; font-family: monospace; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-secondary { background: #10b981; color: white; }
        .alert { padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid; font-size: 12px; line-height: 1.6; }
        .alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
        .alert-warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .alert-error { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .compound-item { background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 12px; }
        .chart-container { height: 500px; margin-top: 16px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 16px; }
        .comparison-table th, .comparison-table td { padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .comparison-table th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .color-indicator { width: 16px; height: 16px; border-radius: 4px; display: inline-block; }
        .step-indicator { display: flex; justify-content: center; gap: 16px; margin-bottom: 24px; }
        .step { padding: 8px 16px; border-radius: 16px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 13px; }
        .step.active { background: #4f46e5; color: white; }
        .info-box { background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; }
        .help-box { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px; font-size: 11px; margin-top: 4px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .route-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .route-btn { padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.3s; }
        .route-btn:hover { border-color: #4f46e5; }
        .route-btn.selected { border-color: #4f46e5; background: #eff6ff; color: #4f46e5; }
        .collapsible { cursor: pointer; padding: 12px; background: #e5e7eb; border-radius: 6px; margin-bottom: 8px; font-weight: 600; font-size: 13px; }
        .collapsible:hover { background: #d1d5db; }
        .collapsible-content { display: none; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 12px; }
        .collapsible-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ§¬ ë²”ìš© In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ</h1>
                <p style="font-size: 13px;">Salt Form ë¹„êµ ë¶„ì„ | ëª¨ë“  í™”í•©ë¬¼ ì ìš© ê°€ëŠ¥</p>
            </div>

            <div class="content">
                <div class="step-indicator">
                    <div class="step active" id="step1">1ï¸âƒ£ ë¬¼ì§ˆ ì…ë ¥</div>
                    <div class="step" id="step2">2ï¸âƒ£ ì¢… ì„¤ì •</div>
                    <div class="step" id="step3">3ï¸âƒ£ ê²°ê³¼ ë¶„ì„</div>
                </div>
                <div id="alerts"></div>
                <div id="main-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1, compounds = [], selectedSpecies = 'mouse', chartInstance = null, alerts = [];
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
        
        const speciesSettings = {
            mouse: { bodyWeight: 0.025, Vd: 4.0, CL: 60, ka: 1.5, label: 'ğŸ­ Mouse' },
            rat: { bodyWeight: 0.25, Vd: 3.5, CL: 50, ka: 1.2, label: 'ğŸ€ Rat' },
            dog: { bodyWeight: 10, Vd: 2.0, CL: 25, ka: 0.8, label: 'ğŸ• Dog (Beagle)' }
        };

        const formulationDB = {
            'water': { label: 'ì •ì œìˆ˜', viscosity: 1, solFactor: 1.0, kaFactor: 1.0 },
            '0.5% MC': { label: '0.5% MC', viscosity: 50, solFactor: 1.3, kaFactor: 0.85 },
            '0.5% MC 4000cP': { label: '0.5% MC (4000 cP)', viscosity: 4000, solFactor: 1.5, kaFactor: 0.7 },
            '0.2% Tween80 in 0.5% MC': { label: '0.2% Tween 80 in 0.5% MC', viscosity: 3800, solFactor: 2.8, kaFactor: 0.75 },
            '0.5% CMC': { label: '0.5% CMC', viscosity: 100, solFactor: 1.4, kaFactor: 0.8 },
            '1% Tween80': { label: '1% Tween 80', viscosity: 5, solFactor: 3.5, kaFactor: 0.95 },
            'PEG400 30%': { label: '30% PEG 400', viscosity: 50, solFactor: 4.5, kaFactor: 1.0 },
            'custom': { label: 'ì§ì ‘ ì…ë ¥', viscosity: 1, solFactor: 1.0, kaFactor: 1.0 }
        };

        function addAlert(type, msg) { alerts.push({ type, msg }); renderAlerts(); }
        function clearAlerts() { alerts = []; renderAlerts(); }
        function renderAlerts() {
            document.getElementById('alerts').innerHTML = alerts.map(a => 
                `<div class="alert alert-${a.type}"><strong>${a.type === 'success' ? 'âœ…' : a.type === 'error' ? 'âŒ' : a.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</strong> ${a.msg}</div>`
            ).join('');
        }

        function addCompound() {
            compounds.push({
                id: Date.now(),
                name: `ë¬¼ì§ˆ ${compounds.length + 1}`,
                
                // í•„ìˆ˜ í•­ëª©
                route: 'PO',
                dose: '10',
                molecularWeight: '',
                pKa: '',
                logP: '',
                
                // Salt form (ììœ  ì…ë ¥)
                saltForm: 'Free base',
                saltMW: '',
                
                // ìš©í•´ë„
                solubility: { pH1_2: '', pH4_5: '', pH6_8: '', faSSIF: '', faSSGF: '', feSSIF: '', water: '' },
                
                // ADME
                papp: '',
                caco2: '',
                permeability: 'medium',
                proteinBinding: '',
                fu: '',
                hepClearance: '',
                bloodPlasmaRatio: '',
                
                // ì œí˜•
                formulation: '0.2% Tween80 in 0.5% MC',
                customFormulation: '',
                
                // ê³ ê¸‰ (ì„ íƒ)
                particleSize_D50: '',
                particleSize_D90: '',
                crystallinity: 'crystalline',
                dissolutionTest: '',
                pgpSubstrate: 'unknown',
                
                pkResult: null,
                color: colors[compounds.length % colors.length]
            });
            render();
        }

        function removeCompound(id) { compounds = compounds.filter(c => c.id !== id); render(); }
        
        function updateCompound(id, field, subfield, value) {
            const c = compounds.find(c => c.id === id);
            if (!c) return;
            if (subfield) c[field][subfield] = value;
            else c[field] = value;
        }

        // ==================== ê³ ê¸‰ PK ê³„ì‚° (ë²”ìš©) ====================
        function calculatePK(compound) {
            const species = selectedSpecies;
            const settings = speciesSettings[species];
            const route = compound.route;
            
            // 1. ê¸°ë³¸ ë¬¼ì„±
            const mw = parseFloat(compound.molecularWeight);
            const logP = parseFloat(compound.logP) || 2.5;
            const pKa = parseFloat(compound.pKa);
            const dose = parseFloat(compound.dose);
            
            if (!mw || !dose) {
                addAlert('error', `${compound.name}: ë¶„ìëŸ‰ê³¼ ìš©ëŸ‰ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                return false;
            }
            
            // 2. Salt correction
            const saltMW = parseFloat(compound.saltMW) || 0;
            const freebaseMW = mw - saltMW;
            const mwCorrection = freebaseMW / mw;
            const effectiveDose = dose * mwCorrection;
            
            // 3. ìš©í•´ë„ ê³„ì‚° (pH ì˜ì¡´ì )
            const baseSol_pH1_2 = parseFloat(compound.solubility.pH1_2 || compound.solubility.faSSGF) || 1;
            const baseSol_pH6_8 = parseFloat(compound.solubility.pH6_8 || compound.solubility.faSSIF) || 1;
            
            // Henderson-Hasselbalch ê¸°ë°˜ ionization
            let ionizationFactor_gastric = 1.0;
            let ionizationFactor_intestinal = 1.0;
            
            if (pKa) {
                // Base compound (ì•½ì—¼ê¸°)
                if (pKa > 7) {
                    ionizationFactor_gastric = 1 / (1 + Math.pow(10, 1.2 - pKa)); // pH 1.2
                    ionizationFactor_intestinal = 1 / (1 + Math.pow(10, 6.8 - pKa)); // pH 6.8
                } 
                // Acid compound (ì•½ì‚°)
                else {
                    ionizationFactor_gastric = 1 / (1 + Math.pow(10, pKa - 1.2));
                    ionizationFactor_intestinal = 1 / (1 + Math.pow(10, pKa - 6.8));
                }
            }
            
            // Salt supersaturation effect
            let supersaturationRatio = 1.0;
            if (compound.saltForm !== 'Free base' && saltMW > 0) {
                supersaturationRatio = 3.0 + (saltMW / freebaseMW) * 5.0; // ê²½í—˜ì‹
            }
            
            // ë¶€í˜•ì œ íš¨ê³¼
            const formEffect = formulationDB[compound.formulation] || formulationDB.water;
            
            const effectiveSol_intestinal = baseSol_pH6_8 * 
                                           ionizationFactor_intestinal * 
                                           supersaturationRatio * 
                                           formEffect.solFactor;
            
            // 4. íˆ¬ê³¼ë„ ê¸°ë°˜ í¡ìˆ˜ìœ¨
            let papp = parseFloat(compound.papp);
            if (!papp && compound.caco2) papp = parseFloat(compound.caco2);
            if (!papp) {
                if (compound.permeability === 'high') papp = 20;
                else if (compound.permeability === 'medium') papp = 8;
                else papp = 2;
            }
            
            // Dissolution-limited vs Permeability-limited
            const solubilityLimited = Math.min(1, (effectiveSol_intestinal * 15) / (mw * 0.03));
            const permeabilityLimited = Math.min(1, papp / 10);
            
            // ì…ìí¬ê¸° íš¨ê³¼
            const particleSize = parseFloat(compound.particleSize_D50) || 50; // Î¼m
            const particleEffect = Math.sqrt(50 / particleSize); // Noyes-Whitney
            
            let Fa = solubilityLimited * permeabilityLimited * particleEffect;
            
            // ê²°ì •í˜• íš¨ê³¼
            if (compound.crystallinity === 'amorphous') Fa = Fa * 1.5;
            
            // 5. ì´ˆíšŒí†µê³¼ íš¨ê³¼
            const hepCL = parseFloat(compound.hepClearance) || settings.CL * 0.4;
            const Fg = 0.92; // ì¥ë²½
            const Fh = 1 - (hepCL / (hepCL + settings.CL * 1.5)); // ê°„
            
            // P-gp íš¨ê³¼
            let pgpFactor = 1.0;
            if (compound.pgpSubstrate === 'yes') pgpFactor = 0.6;
            
            // 6. ê²½ë¡œë³„ ìƒì²´ì´ìš©ë¥ 
            let F;
            if (route === 'IV') F = 1.0;
            else if (route === 'PO') F = Fa * Fg * Fh * pgpFactor;
            else if (route === 'SC') F = 0.85 * Fa;
            else if (route === 'IP') F = 0.9 * Fa * Fh;
            else if (route === 'IM') F = 0.9 * Fa;
            else F = Fa * Fg * Fh;
            
            F = Math.min(0.98, F);
            
            // 7. PK íŒŒë¼ë¯¸í„°
            const fu = parseFloat(compound.fu) || 
                      (compound.proteinBinding ? (100 - parseFloat(compound.proteinBinding)) / 100 : 0.05);
            const bloodPlasmaRatio = parseFloat(compound.bloodPlasmaRatio) || 1.0;
            
            const Vd = (settings.Vd * (1 + logP * 0.5) / Math.max(fu, 0.01)) * bloodPlasmaRatio;
            const CL = (settings.CL * (400 / mw) * 0.75) + (hepCL * 0.25);
            
            let ka = settings.ka * formEffect.kaFactor;
            if (route === 'IV') ka = 99;
            else if (route === 'SC') ka = ka * 0.6;
            else if (route === 'IM') ka = ka * 0.7;
            
            const ke = (CL * 60) / (Vd * 1000);
            
            // 8. ì‹œê°„ë³„ ë†ë„ (Precipitation ê³ ë ¤)
            const timePoints = [];
            for (let t = 0; t <= 24; t += 0.5) {
                let conc;
                
                if (route === 'IV') {
                    conc = (F * effectiveDose * 1000 / (Vd * settings.bodyWeight)) * Math.exp(-ke * t);
                } else {
                    conc = (F * effectiveDose * 1000 / (Vd * settings.bodyWeight)) * 
                           (ka / (ka - ke)) * (Math.exp(-ke * t) - Math.exp(-ka * t));
                }
                
                // Supersaturation decay (ì¹¨ì „)
                if (supersaturationRatio > 1 && t > 0.5) {
                    const decayFactor = 1 - ((supersaturationRatio - 1) / supersaturationRatio) * 
                                       (1 - Math.exp(-t / 2));
                    conc = conc * Math.max(0.5, decayFactor);
                }
                
                timePoints.push({ time: t, concentration: Math.max(0, conc) });
            }
            
            // 9. AUC, Cmax, Tmax
            let auc = 0;
            for (let i = 1; i < timePoints.length; i++) {
                auc += (timePoints[i].concentration + timePoints[i-1].concentration) / 2 * 0.5;
            }
            
            const Cmax = Math.max(...timePoints.map(p => p.concentration));
            const Tmax = timePoints.find(p => p.concentration === Cmax)?.time || 0;
            
            compound.pkResult = {
                profile: timePoints,
                params: {
                    Cmax: Cmax.toFixed(2),
                    Tmax: Tmax.toFixed(1),
                    AUC: auc.toFixed(2),
                    Vd: Vd.toFixed(2),
                    CL: CL.toFixed(2),
                    t_half: (0.693 / ke).toFixed(2),
                    F: (F * 100).toFixed(1),
                    Fa: (Fa * 100).toFixed(1),
                    ka: ka.toFixed(3),
                    ke: ke.toFixed(3)
                }
            };
            
            return true;
        }

        function calculateAll() {
            clearAlerts();
            let success = 0, fail = 0;
            for (let c of compounds) {
                if (calculatePK(c)) success++;
                else fail++;
            }
            if (success > 0) addAlert('success', `âœ… ${success}ê°œ ë¬¼ì§ˆ ê³„ì‚° ì™„ë£Œ!`);
            if (fail > 0) addAlert('error', `âŒ ${fail}ê°œ ë¬¼ì§ˆ ê³„ì‚° ì‹¤íŒ¨`);
        }

        function validateStep1() {
            clearAlerts();
            if (compounds.length === 0) {
                addAlert('warning', 'ìµœì†Œ 1ê°œ ë¬¼ì§ˆì„ ì¶”ê°€í•˜ì„¸ìš”.');
                return false;
            }
            
            for (let c of compounds) {
                if (!c.molecularWeight) {
                    addAlert('error', `${c.name}: ë¶„ìëŸ‰ í•„ìˆ˜`);
                    return false;
                }
                if (!c.dose) {
                    addAlert('error', `${c.name}: íˆ¬ì—¬ ìš©ëŸ‰ í•„ìˆ˜`);
                    return false;
                }
                const solCount = Object.values(c.solubility).filter(v => v !== '').length;
                if (solCount === 0) {
                    addAlert('error', `${c.name}: ìµœì†Œ 1ê°œ ìš©í•´ë„ ì…ë ¥`);
                    return false;
                }
            }
            return true;
        }

        function updateStepIndicator() {
            ['step1', 'step2', 'step3'].forEach((id, idx) => {
                document.getElementById(id).className = 'step' + (currentStep === idx + 1 ? ' active' : '');
            });
        }

        function nextStep() {
            if (currentStep === 1 && !validateStep1()) return;
            if (currentStep < 3) currentStep++;
            if (currentStep === 3) calculateAll();
            render();
        }

        function prevStep() { if (currentStep > 1) currentStep--; render(); }

        function toggleCollapsible(id) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
        }

        function renderStep1() {
            return `
                <div class="info-box">
                    <strong>ğŸ“Œ í•„ìˆ˜ ì…ë ¥ í•­ëª©</strong><br>
                    âœ“ ë¶„ìëŸ‰, ìš©ëŸ‰, ìš©í•´ë„ (ìµœì†Œ 1ê°œ), íˆ¬ì—¬ê²½ë¡œ<br>
                    <strong>ğŸ¯ ê¶Œì¥ ì…ë ¥ (ì •í™•ë„ â†‘)</strong><br>
                    âœ“ pKa (ê°€ì¥ ì¤‘ìš”!), Papp, LogP, ê°„ CL, ì…ìí¬ê¸°
                </div>

                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2 style="font-size: 16px;">ë“±ë¡ ë¬¼ì§ˆ: ${compounds.length}ê°œ</h2>
                    <button class="btn btn-secondary" onclick="addCompound()" style="padding: 8px 16px;">â• ë¬¼ì§ˆ ì¶”ê°€</button>
                </div>

                ${compounds.length === 0 ? '<div class="alert alert-info">ë¬¼ì§ˆì„ ì¶”ê°€í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</div>' : ''}

                ${compounds.map(c => `
                    <div class="compound-item">
                        <div class="flex-between" style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="color-indicator" style="background: ${c.color};"></div>
                                <input type="text" value="${c.name}" onchange="updateCompound(${c.id}, 'name', null, this.value); render();"
                                       style="font-weight: 600; border: 1px solid #e5e7eb; padding: 6px 10px; border-radius: 6px; width: 250px; font-size: 14px;">
                            </div>
                            <button onclick="removeCompound(${c.id}); render();" 
                                    style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </div>

                        <!-- í•„ìˆ˜ ì„¹ì…˜ -->
                        <div class="section">
                            <h2>ğŸ¯ í•„ìˆ˜ í•­ëª©</h2>
                            
                            <h3 style="margin-top: 12px;">ğŸ’Š íˆ¬ì—¬ ê²½ë¡œ</h3>
                            <div class="route-grid">
                                ${['PO', 'IV', 'SC', 'IP', 'IM'].map(route => `
                                    <div class="route-btn ${c.route === route ? 'selected' : ''}"
                                         onclick="updateCompound(${c.id}, 'route', null, '${route}'); render();">
                                        <strong>${route}</strong><br>
                                        <span style="font-size: 10px; color: #6b7280;">
                                            ${route === 'PO' ? 'ê²½êµ¬' : route === 'IV' ? 'ì •ë§¥' : route === 'SC' ? 'í”¼í•˜' : route === 'IP' ? 'ë³µê°•' : 'ê·¼ìœ¡'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>

                            <h3 style="margin-top: 12px;">ğŸ“Š ê¸°ë³¸ ë¬¼ì„±</h3>
                            <div class="grid">
                                <div class="form-group">
                                    <label>ë¶„ìëŸ‰ (MW) <span class="req">*</span></label>
                                    <input type="number" value="${c.molecularWeight}" placeholder="400"
                                           onchange="updateCompound(${c.id}, 'molecularWeight', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>íˆ¬ì—¬ ìš©ëŸ‰ (mg/kg) <span class="req">*</span></label>
                                    <input type="number" value="${c.dose}"
                                           onchange="updateCompound(${c.id}, 'dose', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>pKa <span class="opt">(ê¶Œì¥)</span></label>
                                    <input type="number" step="0.1" value="${c.pKa}" placeholder="5.5"
                                           onchange="updateCompound(${c.id}, 'pKa', null, this.value)">
                                    <div class="help-box">pHë³„ ionization ê³„ì‚°ì— í•„ìˆ˜</div>
                                </div>
                                <div class="form-group">
                                    <label>LogP <span class="opt">(ê¶Œì¥)</span></label>
                                    <input type="number" step="0.1" value="${c.logP}" placeholder="2.5"
                                           onchange="updateCompound(${c.id}, 'logP', null, this.value)">
                                </div>
                            </div>

                            <h3 style="margin-top: 12px;">ğŸ§ª Salt Form</h3>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Salt í˜•íƒœ (ììœ  ì…ë ¥)</label>
                                    <input type="text" value="${c.saltForm}" placeholder="ì˜ˆ: Mesylate, HCl, Tosylate"
                                           onchange="updateCompound(${c.id}, 'saltForm', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>Salt ë¶„ìëŸ‰ <span class="opt">(ë³´ì •ìš©)</span></label>
                                    <input type="number" value="${c.saltMW}" placeholder="ì˜ˆ: 96 (mesylate)"
                                           onchange="updateCompound(${c.id}, 'saltMW', null, this.value)">
                                    <div class="help-box">Free base MW = ì „ì²´ MW - Salt MW</div>
                                </div>
                            </div>

                            <h3 style="margin-top: 12px;">ğŸ’§ ìš©í•´ë„ ë°ì´í„° (Î¼g/mL) <span class="req">*ìµœì†Œ 1ê°œ</span></h3>
                            <div class="grid">
                                ${Object.entries({
                                    pH1_2: 'pH 1.2', pH4_5: 'pH 4.5', pH6_8: 'pH 6.8',
                                    faSSIF: 'FaSSIF', faSSGF: 'FaSSGF', feSSIF: 'FeSSIF', water: 'ì •ì œìˆ˜'
                                }).map(([key, label]) => `
                                    <div class="form-group">
                                        <label>${label}</label>
                                        <input type="number" step="0.01" value="${c.solubility[key]}"
                                               onchange="updateCompound(${c.id}, 'solubility', '${key}', this.value)">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- ADME ì„¹ì…˜ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
                        <div class="collapsible" onclick="toggleCollapsible('adme_${c.id}')">
                            âš—ï¸ ADME íŒŒë¼ë¯¸í„° (ì •í™•ë„ í–¥ìƒ) â–¼
                        </div>
                        <div id="adme_${c.id}" class="collapsible-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>Papp (10â»â¶ cm/s)</label>
                                    <input type="number" step="0.1" value="${c.papp}" placeholder="15"
                                           onchange="updateCompound(${c.id}, 'papp', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>Caco-2 (10â»â¶ cm/s)</label>
                                    <input type="number" step="0.1" value="${c.caco2}" placeholder="12"
                                           onchange="updateCompound(${c.id}, 'caco2', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>íˆ¬ê³¼ë„ ë“±ê¸‰</label>
                                    <select value="${c.permeability}"
                                            onchange="updateCompound(${c.id}, 'permeability', null, this.value)">
                                        <option value="high">High (BCS I, III)</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low (BCS II, IV)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ë‹¨ë°±ê²°í•©ë¥  (%)</label>
                                    <input type="number" value="${c.proteinBinding}" placeholder="95"
                                           onchange="updateCompound(${c.id}, 'proteinBinding', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>ìœ ë¦¬ë¶„ìœ¨ fu (0-1)</label>
                                    <input type="number" step="0.01" value="${c.fu}" placeholder="0.05"
                                           onchange="updateCompound(${c.id}, 'fu', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>ê°„ CL (mL/min/kg)</label>
                                    <input type="number" value="${c.hepClearance}" placeholder="25"
                                           onchange="updateCompound(${c.id}, 'hepClearance', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>Blood/Plasma ratio</label>
                                    <input type="number" step="0.1" value="${c.bloodPlasmaRatio}" placeholder="1.0"
                                           onchange="updateCompound(${c.id}, 'bloodPlasmaRatio', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>P-gp ê¸°ì§ˆ</label>
                                    <select value="${c.pgpSubstrate}"
                                            onchange="updateCompound(${c.id}, 'pgpSubstrate', null, this.value)">
                                        <option value="unknown">ëª¨ë¦„</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ì œí˜• ì„¹ì…˜ -->
                        <div class="collapsible" onclick="toggleCollapsible('form_${c.id}')">
                            ğŸ’Š ì œí˜• ë° ì…ì íŠ¹ì„± â–¼
                        </div>
                        <div id="form_${c.id}" class="collapsible-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>ë¶€í˜•ì œ</label>
                                    <select value="${c.formulation}"
                                            onchange="updateCompound(${c.id}, 'formulation', null, this.value);">
                                        ${Object.entries(formulationDB).map(([k, v]) => 
                                            `<option value="${k}">${v.label}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                ${c.formulation === 'custom' ? `
                                <div class="form-group">
                                    <label>ì§ì ‘ ì…ë ¥</label>
                                    <input type="text" value="${c.customFormulation}" placeholder="ì˜ˆ: 0.3% Tween in CMC"
                                           onchange="updateCompound(${c.id}, 'customFormulation', null, this.value)">
                                </div>
                                ` : ''}
                                <div class="form-group">
                                    <label>ì…ìí¬ê¸° D50 (Î¼m)</label>
                                    <input type="number" value="${c.particleSize_D50}" placeholder="50"
                                           onchange="updateCompound(${c.id}, 'particleSize_D50', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>ì…ìí¬ê¸° D90 (Î¼m)</label>
                                    <input type="number" value="${c.particleSize_D90}" placeholder="100"
                                           onchange="updateCompound(${c.id}, 'particleSize_D90', null, this.value)">
                                </div>
                                <div class="form-group">
                                    <label>ê²°ì •í˜•</label>
                                    <select value="${c.crystallinity}"
                                            onchange="updateCompound(${c.id}, 'crystallinity', null, this.value)">
                                        <option value="crystalline">Crystalline</option>
                                        <option value="amorphous">Amorphous</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}

                ${compounds.length > 0 ? `
                    <button class="btn btn-primary" onclick="nextStep()" style="margin-top: 16px;">
                        â¡ï¸ NEXT: ì¢… ì„¤ì •ìœ¼ë¡œ ì´ë™
                    </button>
                ` : ''}
            `;
        }

        function renderStep2() {
            return `
                <div class="info-box">
                    ğŸ’¡ ë¹„êµ ë¶„ì„ì— ì‚¬ìš©í•  ë™ë¬¼ ì¢…ì„ ì„ íƒí•˜ê³ , í•„ìš”ì‹œ ìƒë¦¬í•™ì  íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì •í•˜ì„¸ìš”.
                </div>
                
                <div class="section">
                    <h2>ğŸ¾ ì‹¤í—˜ ë™ë¬¼ ì¢… ì„ íƒ</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        ${Object.entries(speciesSettings).map(([key, s]) => `
                            <div onclick="selectedSpecies='${key}'; render();"
                                 style="padding: 20px; border: 2px solid ${selectedSpecies === key ? '#4f46e5' : '#e5e7eb'};
                                        border-radius: 8px; cursor: pointer; text-align: center;
                                        background: ${selectedSpecies === key ? '#eff6ff' : 'white'}; transition: all 0.3s;">
                                <div style="font-size: 24px; margin-bottom: 12px;">${s.label}</div>
                                <div style="font-size: 12px; color: #6b7280; line-height: 1.6;">
                                    ì²´ì¤‘: ${s.bodyWeight} kg<br>
                                    Vd: ${s.Vd} L/kg<br>
                                    CL: ${s.CL} mL/min/kg<br>
                                    ka: ${s.ka} hâ»Â¹
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="section">
                    <h2>âš™ï¸ ${speciesSettings[selectedSpecies].label} íŒŒë¼ë¯¸í„° ì¡°ì • (ì„ íƒ)</h2>
                    <div class="grid">
                        <div class="form-group">
                            <label>ì²´ì¤‘ (kg)</label>
                            <input type="number" step="0.001" value="${speciesSettings[selectedSpecies].bodyWeight}"
                                   onchange="speciesSettings['${selectedSpecies}'].bodyWeight = parseFloat(this.value)">
                        </div>
                        <div class="form-group">
                            <label>ë¶„í¬ìš©ì  Vd (L/kg)</label>
                            <input type="number" step="0.1" value="${speciesSettings[selectedSpecies].Vd}"
                                   onchange="speciesSettings['${selectedSpecies}'].Vd = parseFloat(this.value)">
                        </div>
                        <div class="form-group">
                            <label>í´ë¦¬ì–´ëŸ°ìŠ¤ CL (mL/min/kg)</label>
                            <input type="number" step="1" value="${speciesSettings[selectedSpecies].CL}"
                                   onchange="speciesSettings['${selectedSpecies}'].CL = parseFloat(this.value)">
                        </div>
                        <div class="form-group">
                            <label>í¡ìˆ˜ì†ë„ìƒìˆ˜ ka (1/h)</label>
                            <input type="number" step="0.1" value="${speciesSettings[selectedSpecies].ka}"
                                   onchange="speciesSettings['${selectedSpecies}'].ka = parseFloat(this.value)">
                        </div>
                    </div>
                </div>

                <div class="flex-between">
                    <button class="btn" onclick="prevStep()" style="background: #6b7280; color: white; width: 48%;">
                        â¬…ï¸ ì´ì „: ë¬¼ì§ˆ ì…ë ¥
                    </button>
                    <button class="btn btn-primary" onclick="nextStep()" style="width: 48%;">
                        â¡ï¸ ê²°ê³¼ ë¶„ì„ ë³´ê¸°
                    </button>
                </div>
            `;
        }

        function renderStep3() {
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) {
                return '<div class="alert alert-warning">PK ê³„ì‚° ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            return `
                <div class="section">
                    <h2>ğŸ“ˆ ${speciesSettings[selectedSpecies].label} - PK í”„ë¡œíŒŒì¼ ë¹„êµ</h2>
                    <div class="chart-container"><canvas id="pkChart"></canvas></div>
                </div>

                <div class="section">
                    <h2>ğŸ“Š PK íŒŒë¼ë¯¸í„° ë¹„êµí‘œ</h2>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>ë¬¼ì§ˆëª…</th>
                                <th>Salt Form</th>
                                <th>ê²½ë¡œ</th>
                                <th>C<sub>max</sub><br>(ng/mL)</th>
                                <th>T<sub>max</sub><br>(h)</th>
                                <th>AUC<br>(ngÂ·h/mL)</th>
                                <th>t<sub>Â½</sub><br>(h)</th>
                                <th>F<br>(%)</th>
                                <th>Fa<br>(%)</th>
                                <th>V<sub>d</sub><br>(L/kg)</th>
                                <th>CL<br>(mL/min/kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calc.map(c => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div class="color-indicator" style="background: ${c.color};"></div>
                                            <strong>${c.name}</strong>
                                        </div>
                                    </td>
                                    <td>${c.saltForm}</td>
                                    <td><span class="badge badge-purple">${c.route}</span></td>
                                    <td><span class="badge badge-blue">${c.pkResult.params.Cmax}</span></td>
                                    <td>${c.pkResult.params.Tmax}</td>
                                    <td><span class="badge badge-green">${c.pkResult.params.AUC}</span></td>
                                    <td>${c.pkResult.params.t_half}</td>
                                    <td><span class="badge badge-purple">${c.pkResult.params.F}</span></td>
                                    <td>${c.pkResult.params.Fa}</td>
                                    <td>${c.pkResult.params.Vd}</td>
                                    <td>${c.pkResult.params.CL}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                ${calc.length > 1 ? `
                <div class="section">
                    <h2>ğŸ”¬ ìƒëŒ€ ë¹„êµ ë¶„ì„ (ê¸°ì¤€: ${calc[0].name})</h2>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>ë¬¼ì§ˆëª…</th>
                                <th>C<sub>max</sub> ë¹„ìœ¨</th>
                                <th>AUC ë¹„ìœ¨</th>
                                <th>F ë¹„ìœ¨</th>
                                <th>í•´ì„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calc.map((c, idx) => {
                                const ref = calc[0].pkResult.params;
                                const cmaxR = (parseFloat(c.pkResult.params.Cmax) / parseFloat(ref.Cmax) * 100).toFixed(0);
                                const aucR = (parseFloat(c.pkResult.params.AUC) / parseFloat(ref.AUC) * 100).toFixed(0);
                                const fR = (parseFloat(c.pkResult.params.F) / parseFloat(ref.F) * 100).toFixed(0);
                                
                                let interpretation = '';
                                if (idx > 0) {
                                    if (aucR > 150) interpretation = '<span class="badge badge-green">ë§¤ìš° ìš°ìˆ˜</span>';
                                    else if (aucR > 120) interpretation = '<span class="badge badge-green">ìš°ìˆ˜</span>';
                                    else if (aucR >= 80) interpretation = '<span class="badge badge-blue">ìœ ì‚¬</span>';
                                    else if (aucR >= 50) interpretation = '<span class="badge" style="background: #fef3c7; color: #92400e;">ë³´í†µ</span>';
                                    else interpretation = '<span class="badge badge-red">ë‚®ìŒ</span>';
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${c.name}</strong></td>
                                        <td>${idx === 0 ? '<strong>100% (ê¸°ì¤€)</strong>' : cmaxR + '%'}</td>
                                        <td>${idx === 0 ? '<strong>100% (ê¸°ì¤€)</strong>' : aucR + '%'}</td>
                                        <td>${idx === 0 ? '<strong>100% (ê¸°ì¤€)</strong>' : fR + '%'}</td>
                                        <td>${idx === 0 ? '-' : interpretation}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                <div class="alert alert-warning">
                    <strong>âš ï¸ ëª¨ë¸ í•œê³„ ë° ì£¼ì˜ì‚¬í•­</strong><br>
                    â€¢ ë³¸ ì˜ˆì¸¡ì€ simplified compartmental model ê¸°ë°˜ì…ë‹ˆë‹¤<br>
                    â€¢ ì‹¤ì œ PKëŠ” ì¥ë‚´ëŒ€ì‚¬, ë‹´ì¦™ë°°ì„¤, ìŒì‹íš¨ê³¼, ì•½ë¬¼ìƒí˜¸ì‘ìš© ë“± ë‹¤ì–‘í•œ ìš”ì¸ì˜ ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤<br>
                    â€¢ Salt form íš¨ê³¼ëŠ” pKa ë° ì‹¤í—˜ ë°ì´í„° ê¸°ë°˜ ê²½í—˜ì‹ìœ¼ë¡œ ì¶”ì •ë©ë‹ˆë‹¤<br>
                    â€¢ <strong>ë” ì •í™•í•œ ì˜ˆì¸¡ì„ ìœ„í•´ì„œëŠ” ìµœì†Œ 1-2ê°œ í™”í•©ë¬¼ì˜ ì‹¤ì œ PK ë°ì´í„°ë¡œ ëª¨ë¸ì„ ë³´ì •í•˜ì„¸ìš”</strong>
                </div>

                <div class="info-box">
                    <strong>ğŸ“Œ ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒ íŒ</strong><br>
                    âœ“ pKa ê°’ ì…ë ¥ ì‹œ pHë³„ ìš©í•´ë„ ë³€í™”ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤<br>
                    âœ“ Salt MW ì…ë ¥ ì‹œ Free base ê¸°ì¤€ìœ¼ë¡œ ìš©ëŸ‰ì´ ë³´ì •ë©ë‹ˆë‹¤<br>
                    âœ“ ì…ìí¬ê¸° ì…ë ¥ ì‹œ dissolution rateê°€ Noyes-Whitney ì‹ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤<br>
                    âœ“ ê°„ CL ì…ë ¥ ì‹œ ì´ˆíšŒí†µê³¼íš¨ê³¼ê°€ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤<br>
                    âœ“ ìœ ì‚¬ í™”í•©ë¬¼ì˜ ì‹¤ì œ PK ë°ì´í„°ê°€ ìˆë‹¤ë©´ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì •í•˜ì—¬ ë³´ì •í•˜ì„¸ìš”
                </div>

                <div class="flex-between" style="margin-top: 20px;">
                    <button class="btn" onclick="currentStep=1; render();" 
                            style="background: #6b7280; color: white; width: 32%;">
                        ğŸ”„ ì²˜ìŒìœ¼ë¡œ
                    </button>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="width: 32%;">
                        ğŸ’¾ CSV ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button class="btn btn-primary" onclick="window.print()" style="width: 32%;">
                        ğŸ–¨ï¸ ë³´ê³ ì„œ ì¶œë ¥
                    </button>
                </div>
            `;
        }

        function renderChart() {
            const ctx = document.getElementById('pkChart');
            if (!ctx) return;
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return;

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: calc[0].pkResult.profile.map(p => p.time.toFixed(1)),
                    datasets: calc.map(c => ({
                        label: `${c.name} (${c.saltForm}, ${c.route})`,
                        data: c.pkResult.profile.map(p => p.concentration),
                        borderColor: c.color,
                        backgroundColor: c.color + '20',
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 12, weight: '600' } } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' ng/mL'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (hours)', font: { size: 13, weight: '600' } },
                            ticks: { maxTicksLimit: 13 }
                        },
                        y: {
                            title: { display: true, text: 'Concentration (ng/mL)', font: { size: 13, weight: '600' } },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function exportCSV() {
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return;

            let csv = 'Time (h),' + calc.map(c => c.name).join(',') + '\n';
            for (let i = 0; i < calc[0].pkResult.profile.length; i++) {
                const time = calc[0].pkResult.profile[i].time.toFixed(1);
                const values = calc.map(c => c.pkResult.profile[i].concentration.toFixed(4));
                csv += time + ',' + values.join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `pk_prediction_${selectedSpecies}_${Date.now()}.csv`;
            link.click();
        }

        function render() {
            updateStepIndicator();
            const content = document.getElementById('main-content');
            
            if (currentStep === 1) content.innerHTML = renderStep1();
            else if (currentStep === 2) content.innerHTML = renderStep2();
            else content.innerHTML = renderStep3();

            if (currentStep === 3) setTimeout(renderChart, 100);
        }

        render();
    </script>
</body>
</html>