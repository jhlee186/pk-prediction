<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°ë°˜ In Vitroâ€“In Vivo PK ì˜ˆì¸¡ í”Œë«í¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }
        .header h1 { font-size: 26px; margin-bottom: 8px; }
        .content { padding: 30px; }
        .section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 16px; }
        .section h2 { font-size: 16px; margin-bottom: 12px; color: #1f2937; font-weight: 600; }
        .section h3 { font-size: 14px; margin-bottom: 8px; color: #4b5563; font-weight: 600; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .form-group label .req { color: #ef4444; }
        .form-group label .opt { color: #10b981; font-weight: 400; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
        .form-group textarea { min-height: 60px; font-family: monospace; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-secondary { background: #10b981; color: white; }
        .alert { padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid; font-size: 12px; line-height: 1.6; }
        .alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
        .alert-warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .alert-error { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .compound-item { background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 12px; }
        .compound-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .compound-name-editable { font-size: 16px; font-weight: 600; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; flex: 1; }
        .compound-name-editable:focus { outline: none; border-color: #4f46e5; }
        .chart-container { height: 500px; margin-top: 16px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 16px; }
        .comparison-table th, .comparison-table td { padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .comparison-table th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .color-indicator { width: 16px; height: 16px; border-radius: 4px; display: inline-block; }
        .step-indicator { display: flex; justify-content: center; gap: 16px; margin-bottom: 24px; }
        .step { padding: 8px 16px; border-radius: 16px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 13px; }
        .step.active { background: #4f46e5; color: white; }
        .info-box { background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; }
        .help-box { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px; font-size: 11px; margin-top: 4px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .route-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .route-btn { padding: 12px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 600; transition: all 0.3s; }
        .route-btn:hover { border-color: #4f46e5; }
        .route-btn.selected { border-color: #4f46e5; background: #eff6ff; color: #4f46e5; }
        .collapsible-content { display: block; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 12px; }
        
        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            line-height: 1.5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ§¬ AI ê¸°ë°˜ In Vitroâ€“In Vivo PK ì˜ˆì¸¡ í”Œë«í¼</h1>
                <p style="font-size: 13px;">ëŒ€ì›…ì œì•½ ì‹ ì•½í•©ì„±ì—°êµ¬íŒ€ PreformulationíŒŒíŠ¸</p>
            </div>

            <div class="content">
                <div class="step-indicator">
                    <div class="step active" id="step1">1ï¸âƒ£ ë¬¼ì§ˆ ì…ë ¥</div>
                    <div class="step" id="step2">2ï¸âƒ£ ì¢… ì„¤ì •</div>
                    <div class="step" id="step3">3ï¸âƒ£ ê²°ê³¼ ë¶„ì„</div>
                </div>
                <div id="alerts"></div>
                <div id="main-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1, compounds = [], selectedSpecies = 'rat', chartInstance = null, alerts = [];
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
        
        const speciesSettings = {
            rat: { bodyWeight: 0.25, Vd: 3.5, CL: 50, ka: 1.2, label: 'ğŸ€ Rat' },
            dog: { bodyWeight: 10, Vd: 2.0, CL: 25, ka: 0.8, label: 'ğŸ• Dog (Beagle)' }
        };

        const formulationDB = {
            'water': { label: 'ì •ì œìˆ˜', viscosity: 1, solFactor: 1.0, kaFactor: 1.0 },
            '0.5% MC': { label: '0.5% MC', viscosity: 50, solFactor: 1.3, kaFactor: 0.85 },
            '0.5% MC 4000cP': { label: '0.5% MC (4000 cP)', viscosity: 4000, solFactor: 1.5, kaFactor: 0.7 },
            '0.2% Tween80 in 0.5% MC': { label: '0.2% Tween 80 in 0.5% MC', viscosity: 3800, solFactor: 2.8, kaFactor: 0.75 },
            '0.5% CMC': { label: '0.5% CMC', viscosity: 100, solFactor: 1.4, kaFactor: 0.8 },
            '1% Tween80': { label: '1% Tween 80', viscosity: 5, solFactor: 3.5, kaFactor: 0.95 },
            'PEG400 30%': { label: '30% PEG 400', viscosity: 50, solFactor: 4.5, kaFactor: 1.0 },
            'Solutol 10%': { label: 'Solutol 10%', viscosity: 8, solFactor: 5.0, kaFactor: 1.05 },
            'Captisol 10%': { label: 'Captisol 10%', viscosity: 3, solFactor: 6.0, kaFactor: 1.1 },
            'custom': { label: 'ì§ì ‘ ì…ë ¥', viscosity: 1, solFactor: 1.0, kaFactor: 1.0 }
        };

        const tooltips = {
            route: 'íˆ¬ì—¬ê²½ë¡œ: ì•½ë¬¼ì´ ì²´ë‚´ì— íˆ¬ì…ë˜ëŠ” ë°©ì‹<br>â€¢ PO (ê²½êµ¬): ìœ„ì¥ê´€ì„ í†µí•œ í¡ìˆ˜<br>â€¢ IV (ì •ë§¥): í˜ˆê´€ì— ì§ì ‘ íˆ¬ì—¬',
            dose: 'íˆ¬ì—¬ëŸ‰: ë™ë¬¼ì—ê²Œ íˆ¬ì—¬í•  ì•½ë¬¼ì˜ ì–‘<br>ë‹¨ìœ„: mg/kg (ì²´ì¤‘ kgë‹¹ mg)<br>ì¼ë°˜ì  ë²”ìœ„: 1-100 mg/kg',
            molecularWeight: 'ë¶„ìëŸ‰: ì•½ë¬¼ ë¶„ìì˜ ì§ˆëŸ‰<br>ë‹¨ìœ„: g/mol<br>ì¼ë°˜ì  ë²”ìœ„: 150-800 g/mol<br>ì˜ˆ: Aspirin=180, Ibuprofen=206',
            pKa: 'pKa: ì‚°í•´ë¦¬ìƒìˆ˜ (ì‚°ì„±ë„ ì§€í‘œ)<br>â€¢ pKa < 5: ì‚°ì„± ì•½ë¬¼<br>â€¢ pKa 5-9: ì¤‘ì„±<br>â€¢ pKa > 9: ì—¼ê¸°ì„± ì•½ë¬¼<br>pHë³„ ìš©í•´ë„ ê³„ì‚°ì— ì‚¬ìš©ë©ë‹ˆë‹¤',
            logP: 'LogP: ì˜¥íƒ„ì˜¬/ë¬¼ ë¶„ë°°ê³„ìˆ˜ (ì¹œìœ ì„± ì§€í‘œ)<br>â€¢ LogP < 0: ì¹œìˆ˜ì„±<br>â€¢ LogP 0-3: ì ì ˆí•œ ì¹œìœ ì„±<br>â€¢ LogP > 5: ë§¤ìš° ì¹œìœ ì„±<br>íˆ¬ê³¼ì„± ì˜ˆì¸¡ì— ì‚¬ìš©ë©ë‹ˆë‹¤',
            solubility: 'ìš©í•´ë„: pHë³„ ì•½ë¬¼ ìš©í•´ë„<br>ë‹¨ìœ„: Î¼g/mL<br>ìš©í•´ë„ê°€ ë†’ì„ìˆ˜ë¡ í¡ìˆ˜ê°€ ë¹ ë¦…ë‹ˆë‹¤<br>BCS ë¶„ë¥˜ ë° ìƒì²´ì´ìš©ë¥  ì˜ˆì¸¡ì— í•„ìˆ˜',
            caco2: 'Caco-2 íˆ¬ê³¼ë„<br>ë‹¨ìœ„: 10â»â¶ cm/s<br>â€¢ <1: ë‚®ì€ íˆ¬ê³¼ì„± (BCS III, IV)<br>â€¢ 1-10: ì¤‘ê°„ íˆ¬ê³¼ì„±<br>â€¢ >10: ë†’ì€ íˆ¬ê³¼ì„± (BCS I, II)<br>ì¥ ìƒí”¼ì„¸í¬ íˆ¬ê³¼ ëŠ¥ë ¥ ì¸¡ì •',
            bcsClass: 'BCS ë¶„ë¥˜ (Biopharmaceutics Classification System)<br>ìš©í•´ë„ì™€ íˆ¬ê³¼ì„±ì— ë”°ë¥¸ ë¶„ë¥˜:<br>â€¢ Class I: ê³ ìš©í•´ë„/ê³ íˆ¬ê³¼ì„± (F>80%)<br>â€¢ Class II: ì €ìš©í•´ë„/ê³ íˆ¬ê³¼ì„± (F ê°€ë³€ì )<br>â€¢ Class III: ê³ ìš©í•´ë„/ì €íˆ¬ê³¼ì„± (F<50%)<br>â€¢ Class IV: ì €ìš©í•´ë„/ì €íˆ¬ê³¼ì„± (F<30%)',
            proteinBinding: 'í˜ˆì¥ë‹¨ë°±ì§ˆ ê²°í•©ë¥ <br>ë‹¨ìœ„: % (0-100)<br>â€¢ <80%: ë‚®ì€ ê²°í•©<br>â€¢ 80-95%: ì¤‘ê°„ ê²°í•©<br>â€¢ >95%: ë†’ì€ ê²°í•©<br>ë¶„í¬ìš©ì (Vd) ê³„ì‚°ì— ì˜í–¥',
            hepClearance: 'ê°„ í´ë¦¬ì–´ëŸ°ìŠ¤<br>ë‹¨ìœ„: mL/min/kg<br>ê°„ì—ì„œì˜ ì•½ë¬¼ ëŒ€ì‚¬ ì†ë„<br>ì´ˆíšŒí†µê³¼íš¨ê³¼ ë° ì „ì‹  ì œê±°ìœ¨ ê³„ì‚°<br><strong>PK ì˜ˆì¸¡ì˜ ê°€ì¥ ì¤‘ìš”í•œ íŒŒë¼ë¯¸í„°</strong>',
            logD: 'LogD (pH 7.4): ìƒë¦¬ì  pHì—ì„œì˜ ë¶„ë°°ê³„ìˆ˜<br>LogPì™€ ë‹¬ë¦¬ ì´ì˜¨í™” ìƒíƒœë¥¼ ê³ ë ¤<br>â€¢ LogD < 0: ì¹œìˆ˜ì„±<br>â€¢ LogD 1-3: ìµœì  ì¹œìœ ì„±<br>â€¢ LogD > 5: ê³¼ë„í•œ ì¹œìœ ì„±<br>ë§‰ íˆ¬ê³¼ì„± ë° Vd ì˜ˆì¸¡ì— ì¤‘ìš”',
            formulation: 'ë¶€í˜•ì œ íš¨ê³¼:<br>â€¢ ì •ì œìˆ˜: ìš©í•´ë„ 1ë°° (ê¸°ì¤€)<br>â€¢ 0.5% MC: 1.3ë°° ì¦ê°€<br>â€¢ Tween 80: 3-4ë°° ì¦ê°€ (ê³„ë©´í™œì„±ì œ)<br>â€¢ PEG 400: 4.5ë°° ì¦ê°€ (ê°€ìš©í™”ì œ)<br>â€¢ Solutol 10%: 5ë°° ì¦ê°€<br>â€¢ Captisol 10%: 6ë°° ì¦ê°€ (cyclodextrin)',
            particleSize: 'ì…ì í¬ê¸° (Particle Size)<br>ë‹¨ìœ„: Î¼m<br>â€¢ D50: ì¤‘ì•™ê°’ (50% ì…ìê°€ ì´ë³´ë‹¤ ì‘ìŒ)<br>â€¢ D90: 90% ì…ìê°€ ì´ë³´ë‹¤ ì‘ìŒ)<br>ì‘ì„ìˆ˜ë¡ ìš©í•´ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤<br>Noyes-Whitney ì‹ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤',
            doseVolume: 'íˆ¬ì—¬ ë¶€í”¼<br>ë‹¨ìœ„: mL/kg<br>ì¼ë°˜ì  ë²”ìœ„: 5-20 mL/kg<br>ë¶€í”¼ê°€ í´ìˆ˜ë¡ ìœ„ì¥ ì²´ë¥˜ì‹œê°„ ì¦ê°€<br>ìš©í•´ë„ ì œí•œ ì•½ë¬¼ì˜ í¡ìˆ˜ì— ì˜í–¥'
        };

        function createTooltip(key) {
            return `<span class="tooltip"><span class="info-icon">i</span><span class="tooltiptext">${tooltips[key]}</span></span>`;
        }

        function addAlert(type, msg) { alerts.push({ type, msg }); renderAlerts(); }
        function clearAlerts() { alerts = []; renderAlerts(); }
        function renderAlerts() {
            document.getElementById('alerts').innerHTML = alerts.map(a => 
                `<div class="alert alert-${a.type}"><strong>${a.type === 'success' ? 'âœ…' : a.type === 'error' ? 'âŒ' : a.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</strong> ${a.msg}</div>`
            ).join('');
        }

        function addCompound() {
            const defaultName = compounds.length === 0 ? 'ë¬¼ì§ˆ 1' : `ë¬¼ì§ˆ ${compounds.length + 1}`;
            compounds.push({
                id: Date.now(),
                name: defaultName,
                
                // í•„ìˆ˜ í•­ëª©
                route: 'PO',
                dose: '10',
                molecularWeight: '',
                pKa: '',
                logP: '',
                logD: '',
                
                // ìš©í•´ë„
                solubility: { pH1_2: '', pH4_5: '', pH6_8: '', faSSIF: '', faSSGF: '', feSSIF: '', water: '' },
                
                // ADME (ê°„ì†Œí™”)
                caco2: '',
                bcsClass: '2',
                proteinBinding: '',
                hepClearance: '',
                
                // ì œí˜•
                formulation: 'water',
                customFormulation: '',
                doseVolume: '10',
                
                // ì…ì íŠ¹ì„±
                particleSize_D50: '',
                particleSize_D90: ''
            });
            render();
        }

        function removeCompound(id) {
            compounds = compounds.filter(c => c.id !== id);
            render();
        }

        function updateCompound(id, field, value) {
            const c = compounds.find(c => c.id === id);
            if (!c) return;
            
            if (field.startsWith('solubility.')) {
                const solField = field.split('.')[1];
                c.solubility[solField] = value;
            } else {
                c[field] = value;
            }
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById('step' + i);
                if (el) el.classList.toggle('active', i === currentStep);
            }
        }

        function renderStep1() {
            return `
                <div class="section">
                    <div class="flex-between">
                        <h2>ğŸ“‹ ë¬¼ì§ˆ ì •ë³´ ì…ë ¥</h2>
                        <button class="btn btn-secondary" onclick="addCompound()">
                            â• ë¬¼ì§ˆ ì¶”ê°€
                        </button>
                    </div>
                    
                    ${compounds.length === 0 ? `
                        <div class="alert alert-info" style="margin-top: 16px;">
                            <strong>â„¹ï¸ ì‹œì‘í•˜ê¸°</strong><br>
                            "ë¬¼ì§ˆ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¹„êµí•  ë¬¼ì§ˆì„ ì…ë ¥í•˜ì„¸ìš”<br>
                            ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¼ì§ˆì´ í•„ìš”í•©ë‹ˆë‹¤
                        </div>
                    ` : ''}

                    <div id="compounds-container">
                        ${compounds.map((c, idx) => `
                            <div class="compound-item">
                                <div class="compound-header">
                                    <span class="color-indicator" style="background: ${colors[idx % colors.length]};"></span>
                                    <input type="text" 
                                           class="compound-name-editable" 
                                           value="${c.name}" 
                                           onchange="updateCompound(${c.id}, 'name', this.value); render();"
                                           placeholder="ë¬¼ì§ˆëª… ì…ë ¥ (í•„ìˆ˜)">
                                    ${compounds.length > 1 ? `
                                        <button class="btn" onclick="removeCompound(${c.id})" 
                                                style="background: #ef4444; color: white; padding: 6px 12px; font-size: 12px;">
                                            ğŸ—‘ï¸ ì‚­ì œ
                                        </button>
                                    ` : ''}
                                </div>

                                <div class="grid">
                                    <div class="form-group">
                                        <label>íˆ¬ì—¬ ê²½ë¡œ <span class="req">*</span> ${createTooltip('route')}</label>
                                        <select onchange="updateCompound(${c.id}, 'route', this.value)">
                                            <option value="PO" ${c.route === 'PO' ? 'selected' : ''}>PO (ê²½êµ¬)</option>
                                            <option value="IV" ${c.route === 'IV' ? 'selected' : ''}>IV (ì •ë§¥)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>íˆ¬ì—¬ëŸ‰ (mg/kg) <span class="req">*</span> ${createTooltip('dose')}</label>
                                        <input type="number" step="0.1" value="${c.dose}" 
                                               onchange="updateCompound(${c.id}, 'dose', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>ë¶„ìëŸ‰ (g/mol) <span class="req">*</span> ${createTooltip('molecularWeight')}</label>
                                        <input type="number" step="0.01" value="${c.molecularWeight}" 
                                               onchange="updateCompound(${c.id}, 'molecularWeight', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>pKa <span class="opt">(ì„ íƒ)</span> ${createTooltip('pKa')}</label>
                                        <input type="number" step="0.1" value="${c.pKa}" 
                                               onchange="updateCompound(${c.id}, 'pKa', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>LogP <span class="req">*</span> ${createTooltip('logP')}</label>
                                        <input type="number" step="0.1" value="${c.logP}" 
                                               onchange="updateCompound(${c.id}, 'logP', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>LogD (pH 7.4) <span class="opt">(ì„ íƒ)</span> ${createTooltip('logD')}</label>
                                        <input type="number" step="0.1" value="${c.logD}" 
                                               onchange="updateCompound(${c.id}, 'logD', this.value)">
                                    </div>
                                </div>

                                <h3 style="margin-top: 20px;">ğŸ’§ ìš©í•´ë„ ë°ì´í„° ${createTooltip('solubility')}</h3>
                                <div class="help-box">
                                    pHë³„ë¡œ í•˜ë‚˜ ì´ìƒì˜ ìš©í•´ë„ë¥¼ ì…ë ¥í•˜ë©´ ë” ì •í™•í•œ ì˜ˆì¸¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨ìœ„: Î¼g/mL
                                </div>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>pH 1.2 (HCl buffer) <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.pH1_2}" 
                                               onchange="updateCompound(${c.id}, 'solubility.pH1_2', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>pH 4.5 (Acetate buffer) <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.pH4_5}" 
                                               onchange="updateCompound(${c.id}, 'solubility.pH4_5', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>pH 6.8 (Phosphate buffer) <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.pH6_8}" 
                                               onchange="updateCompound(${c.id}, 'solubility.pH6_8', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>FaSSIF (ì¸ê³µì¥ì•¡, ì‹ì „) <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.faSSIF}" 
                                               onchange="updateCompound(${c.id}, 'solubility.faSSIF', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>FaSSGF (ì¸ê³µìœ„ì•¡) <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.faSSGF}" 
                                               onchange="updateCompound(${c.id}, 'solubility.faSSGF', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>FeSSIF (ì¸ê³µì¥ì•¡, ì‹í›„) <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.feSSIF}" 
                                               onchange="updateCompound(${c.id}, 'solubility.feSSIF', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>ì •ì œìˆ˜ <span class="opt">(ì„ íƒ)</span></label>
                                        <input type="number" step="0.01" value="${c.solubility.water}" 
                                               onchange="updateCompound(${c.id}, 'solubility.water', this.value)">
                                    </div>
                                </div>

                                <div class="collapsible-content">
                                    <h3>ğŸ§ª ADME íŒŒë¼ë¯¸í„°</h3>
                                    <div class="help-box">
                                        Caco-2 ë˜ëŠ” BCS Class ì…ë ¥ìœ¼ë¡œ ê¸°ë³¸ ì˜ˆì¸¡ ê°€ëŠ¥. ê°„ í´ë¦¬ì–´ëŸ°ìŠ¤ ì…ë ¥ ì‹œ ì •í™•ë„ í¬ê²Œ í–¥ìƒ.
                                    </div>
                                    <div class="grid">
                                        <div class="form-group">
                                            <label>Caco-2 (10â»â¶ cm/s) <span class="opt">(ì„ íƒ)</span> ${createTooltip('caco2')}</label>
                                            <input type="number" step="0.01" value="${c.caco2}" 
                                                   onchange="updateCompound(${c.id}, 'caco2', this.value)">
                                        </div>
                                        <div class="form-group">
                                            <label>BCS Class ${createTooltip('bcsClass')}</label>
                                            <select onchange="updateCompound(${c.id}, 'bcsClass', this.value)">
                                                <option value="1" ${c.bcsClass === '1' ? 'selected' : ''}>Class I (ê³ ìš©í•´ë„/ê³ íˆ¬ê³¼ì„±)</option>
                                                <option value="2" ${c.bcsClass === '2' ? 'selected' : ''}>Class II (ì €ìš©í•´ë„/ê³ íˆ¬ê³¼ì„±)</option>
                                                <option value="3" ${c.bcsClass === '3' ? 'selected' : ''}>Class III (ê³ ìš©í•´ë„/ì €íˆ¬ê³¼ì„±)</option>
                                                <option value="4" ${c.bcsClass === '4' ? 'selected' : ''}>Class IV (ì €ìš©í•´ë„/ì €íˆ¬ê³¼ì„±)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>ë‹¨ë°±ê²°í•©ë¥  (%) <span class="opt">(ì„ íƒ)</span> ${createTooltip('proteinBinding')}</label>
                                            <input type="number" step="0.1" min="0" max="100" value="${c.proteinBinding}" 
                                                   onchange="updateCompound(${c.id}, 'proteinBinding', this.value)">
                                        </div>
                                        <div class="form-group">
                                            <label>ê°„ CL (mL/min/kg) <span class="opt">(ì„ íƒ)</span> ${createTooltip('hepClearance')}</label>
                                            <input type="number" step="0.1" value="${c.hepClearance}" 
                                                   onchange="updateCompound(${c.id}, 'hepClearance', this.value)">
                                        </div>
                                    </div>
                                </div>

                                <div class="collapsible-content">
                                    <h3>ğŸ’Š ì œí˜• ë° ì…ì íŠ¹ì„±</h3>
                                    <div class="grid">
                                        <div class="form-group">
                                            <label>ë¶€í˜•ì œ ${createTooltip('formulation')}</label>
                                            <select onchange="updateCompound(${c.id}, 'formulation', this.value)">
                                                ${Object.entries(formulationDB).map(([key, val]) => 
                                                    `<option value="${key}" ${c.formulation === key ? 'selected' : ''}>${val.label}</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        ${c.formulation === 'custom' ? `
                                            <div class="form-group">
                                                <label>ë¶€í˜•ì œëª…</label>
                                                <input type="text" value="${c.customFormulation}" 
                                                       onchange="updateCompound(${c.id}, 'customFormulation', this.value)">
                                            </div>
                                        ` : ''}
                                        <div class="form-group">
                                            <label>íˆ¬ì—¬ ë¶€í”¼ (mL/kg) <span class="opt">(ì„ íƒ)</span> ${createTooltip('doseVolume')}</label>
                                            <input type="number" step="0.1" value="${c.doseVolume}" 
                                                   onchange="updateCompound(${c.id}, 'doseVolume', this.value)">
                                        </div>
                                        <div class="form-group">
                                            <label>ì…ìí¬ê¸° D50 (Î¼m) <span class="opt">(ì„ íƒ)</span> ${createTooltip('particleSize')}</label>
                                            <input type="number" step="0.01" value="${c.particleSize_D50}" 
                                                   onchange="updateCompound(${c.id}, 'particleSize_D50', this.value)">
                                        </div>
                                        <div class="form-group">
                                            <label>ì…ìí¬ê¸° D90 (Î¼m) <span class="opt">(ì„ íƒ)</span> ${createTooltip('particleSize')}</label>
                                            <input type="number" step="0.01" value="${c.particleSize_D90}" 
                                                   onchange="updateCompound(${c.id}, 'particleSize_D90', this.value)">
                                        </div>
                                    </div>
                                </div>

                            </div>
                        `).join('')}
                    </div>
                </div>

                <button class="btn btn-primary" onclick="validateAndNext()">
                    ë‹¤ìŒ ë‹¨ê³„ â†’
                </button>
            `;
        }

        function validateAndNext() {
            clearAlerts();
            
            if (compounds.length === 0) {
                addAlert('error', 'ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¼ì§ˆì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤');
                return;
            }
            
            for (let i = 0; i < compounds.length; i++) {
                const c = compounds[i];
                if (!c.name || c.name.trim() === '') {
                    addAlert('error', `ë¬¼ì§ˆ ${i+1}: ë¬¼ì§ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”`);
                    return;
                }
                if (!c.molecularWeight || !c.logP || !c.dose) {
                    addAlert('error', `${c.name}: í•„ìˆ˜ í•­ëª©(ë¶„ìëŸ‰, LogP, íˆ¬ì—¬ëŸ‰)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”`);
                    return;
                }
            }
            
            currentStep = 2;
            render();
        }

        function renderStep2() {
            return `
                <div class="section">
                    <h2>ğŸ¾ ë™ë¬¼ ì¢… ì„ íƒ</h2>
                    <div class="help-box" style="margin-bottom: 16px;">
                        ì˜ˆì¸¡í•  ë™ë¬¼ ì¢…ì„ ì„ íƒí•˜ì„¸ìš”. ê° ì¢…ë§ˆë‹¤ ì²´ì¤‘, ì•½ë™í•™ íŒŒë¼ë¯¸í„°ê°€ ë‹¤ë¥´ê²Œ ì ìš©ë©ë‹ˆë‹¤.
                    </div>
                    
                    <div class="route-grid">
                        ${Object.entries(speciesSettings).map(([key, val]) => `
                            <div class="route-btn ${selectedSpecies === key ? 'selected' : ''}" 
                                 onclick="selectedSpecies='${key}'; render();">
                                <div style="font-size: 24px; margin-bottom: 4px;">${val.label.split(' ')[0]}</div>
                                <div style="font-size: 12px;">${val.label.split(' ').slice(1).join(' ')}</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                                    BW: ${val.bodyWeight} kg<br>
                                    Vd: ${val.Vd} L/kg
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="flex-between" style="margin-top: 20px;">
                    <button class="btn" onclick="currentStep=1; render();" 
                            style="background: #6b7280; color: white; width: 48%;">
                        â† ì´ì „
                    </button>
                    <button class="btn btn-primary" onclick="calculatePK()" style="width: 48%;">
                        ğŸ§® PK ì˜ˆì¸¡ ì‹¤í–‰
                    </button>
                </div>
            `;
        }

        function calculatePK() {
            clearAlerts();
            addAlert('info', 'ì•½ë™í•™ íŒŒë¼ë¯¸í„°ë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...');
            
            const species = speciesSettings[selectedSpecies];
            
            compounds.forEach((c, idx) => {
                c.color = colors[idx % colors.length];
                
                // ìš©ëŸ‰
                let effectiveDose = parseFloat(c.dose);
                
                // ìš©í•´ë„ ê³„ì‚°
                let solubility = 10;
                const solData = c.solubility;
                if (solData.pH6_8) solubility = parseFloat(solData.pH6_8);
                else if (solData.faSSIF) solubility = parseFloat(solData.faSSIF);
                else if (solData.pH4_5) solubility = parseFloat(solData.pH4_5);
                else if (solData.water) solubility = parseFloat(solData.water);
                
                // ì œí˜• íš¨ê³¼
                const formEffect = formulationDB[c.formulation] || formulationDB['water'];
                solubility *= formEffect.solFactor;
                
                // íˆ¬ê³¼ì„± - Caco-2 ë˜ëŠ” BCS Classë¡œë¶€í„°
                let perm = 5.0;
                if (c.caco2) {
                    perm = parseFloat(c.caco2);
                } else {
                    const bcsClass = c.bcsClass || '2';
                    if (bcsClass === '1' || bcsClass === '2') perm = 15.0;
                    else if (bcsClass === '3' || bcsClass === '4') perm = 2.0;
                }
                
                const logP = parseFloat(c.logP);
                const logD = c.logD ? parseFloat(c.logD) : logP;
                
                // LogDë¥¼ ì‚¬ìš©í•œ íˆ¬ê³¼ì„± ë³´ì •
                perm *= Math.pow(10, Math.min(logD * 0.35, 1.5));
                
                // í¡ìˆ˜ìœ¨ - BCS Class ê³ ë ¤
                let F = 0.5;
                const bcsClass = c.bcsClass || '2';
                
                if (bcsClass === '1') {
                    F = 0.85;
                } else if (bcsClass === '2') {
                    if (solubility > 100) F = 0.75;
                    else if (solubility > 10) F = 0.5;
                    else if (solubility > 1) F = 0.3;
                    else F = 0.15;
                } else if (bcsClass === '3') {
                    F = 0.45;
                } else if (bcsClass === '4') {
                    if (solubility > 10) F = 0.3;
                    else if (solubility > 1) F = 0.2;
                    else F = 0.1;
                }
                
                if (logD > 4) F *= 0.85;
                
                // íˆ¬ì—¬ ë¶€í”¼ íš¨ê³¼
                if (c.doseVolume) {
                    const volume = parseFloat(c.doseVolume);
                    if (volume > 15) F *= 1.1;
                    else if (volume < 5) F *= 0.9;
                }
                
                // ì´ˆíšŒí†µê³¼ íš¨ê³¼
                let clh = 0;
                if (c.hepClearance) {
                    clh = parseFloat(c.hepClearance);
                } else {
                    clh = species.CL * (1 + logD * 0.1);
                }
                
                if (clh > 0 && c.route === 'PO') {
                    const liverFlow = 70;
                    const extractionRatio = Math.min(clh / liverFlow, 0.9);
                    F *= (1 - extractionRatio);
                }
                
                if (c.route === 'IV') F = 1.0;
                
                // ë¶„í¬ìš©ì  - LogD ê¸°ë°˜
                let Vd = species.Vd;
                if (logD > 3) Vd *= (1 + (logD - 3) * 0.6);
                else if (logD < 0) Vd *= 0.7;
                
                // ë‹¨ë°±ê²°í•© íš¨ê³¼
                if (c.proteinBinding) {
                    const pb = parseFloat(c.proteinBinding);
                    const fu = (100 - pb) / 100;
                    if (fu < 0.1) Vd *= 0.7;
                }
                
                // í´ë¦¬ì–´ëŸ°ìŠ¤
                let CL = clh;
                
                const k_el = CL / Vd;
                const t_half = 0.693 / k_el;
                
                // í¡ìˆ˜ì†ë„ìƒìˆ˜
                let ka = species.ka * formEffect.kaFactor;
                if (c.particleSize_D50) {
                    const d50 = parseFloat(c.particleSize_D50);
                    ka *= Math.pow(50 / d50, 0.5);
                }
                
                // ë†ë„ ê³„ì‚°
                const MW = parseFloat(c.molecularWeight);
                const dose_mg = effectiveDose * species.bodyWeight * 1000;
                const dose_umol = (dose_mg / MW) * 1000;
                const dose_absorbed = dose_umol * F;
                
                const Vd_mL = Vd * species.bodyWeight * 1000;
                const C0 = (dose_absorbed / Vd_mL) * MW;
                
                let profile = [];
                for (let t = 0; t <= 24; t += 0.25) {
                    let conc = 0;
                    if (c.route === 'IV') {
                        conc = C0 * Math.exp(-k_el * t);
                    } else {
                        conc = (C0 * ka / (ka - k_el)) * (Math.exp(-k_el * t) - Math.exp(-ka * t));
                    }
                    profile.push({ time: t, concentration: Math.max(conc, 0) });
                }
                
                const Cmax = Math.max(...profile.map(p => p.concentration));
                const Tmax = profile.find(p => p.concentration === Cmax)?.time || 0;
                const AUC = profile.reduce((sum, p, i, arr) => {
                    if (i === 0) return 0;
                    return sum + (arr[i-1].concentration + p.concentration) * 0.25 / 2;
                }, 0);
                
                // fu ê³„ì‚° (ê²°ê³¼ í‘œì‹œìš©)
                let fu = 0.1;
                if (c.proteinBinding) {
                    fu = (100 - parseFloat(c.proteinBinding)) / 100;
                } else {
                    fu = 1 / (1 + Math.pow(10, logD - 1.5));
                }
                
                c.pkResult = {
                    params: { Cmax: Cmax.toFixed(2), Tmax: Tmax.toFixed(2), AUC: AUC.toFixed(2), 
                              t_half: t_half.toFixed(2), F: (F * 100).toFixed(0), Vd: Vd.toFixed(2), 
                              CL: CL.toFixed(2), fu: fu.toFixed(3) },
                    profile: profile
                };
            });
            
            clearAlerts();
            addAlert('success', 'ì•½ë™í•™ ì˜ˆì¸¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            currentStep = 3;
            render();
        }

        function renderStep3() {
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return '<div class="alert alert-error">ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';

            return `
                <div class="section">
                    <h2>ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼ - ${speciesSettings[selectedSpecies].label}</h2>
                    
                    <div class="chart-container">
                        <canvas id="pkChart"></canvas>
                    </div>

                    <h3 style="margin-top: 24px;">ğŸ“ˆ ì•½ë™í•™ íŒŒë¼ë¯¸í„° ìš”ì•½</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>ë¬¼ì§ˆ</th>
                                <th>ê²½ë¡œ</th>
                                <th>Cmax (ng/mL)</th>
                                <th>Tmax (h)</th>
                                <th>AUC (ngÂ·h/mL)</th>
                                <th>tÂ½ (h)</th>
                                <th>F (%)</th>
                                <th>Vd (L/kg)</th>
                                <th>CL (mL/min/kg)</th>
                                <th>fu</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calc.map(c => `
                                <tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td><span class="badge ${c.route === 'PO' ? 'badge-blue' : 'badge-purple'}">${c.route}</span></td>
                                    <td>${c.pkResult.params.Cmax}</td>
                                    <td>${c.pkResult.params.Tmax}</td>
                                    <td>${c.pkResult.params.AUC}</td>
                                    <td>${c.pkResult.params.t_half}</td>
                                    <td>${c.pkResult.params.F}</td>
                                    <td>${c.pkResult.params.Vd}</td>
                                    <td>${c.pkResult.params.CL}</td>
                                    <td>${c.pkResult.params.fu}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                ${calc.length > 1 ? `
                <div class="section">
                    <h2>ğŸ”„ ë¬¼ì§ˆ ê°„ ë¹„êµ ë¶„ì„</h2>
                    <p style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">
                        ì²« ë²ˆì§¸ ë¬¼ì§ˆì„ ê¸°ì¤€(100%)ìœ¼ë¡œ ìƒëŒ€ì  ë…¸ì¶œëŸ‰ì„ ë¹„êµí•©ë‹ˆë‹¤
                    </p>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>ë¬¼ì§ˆ</th>
                                <th>ìƒëŒ€ Cmax</th>
                                <th>ìƒëŒ€ AUC</th>
                                <th>ìƒëŒ€ F</th>
                                <th>í•´ì„</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calc.map((c, idx) => {
                                const ref = calc[0].pkResult.params;
                                const cmaxR = (parseFloat(c.pkResult.params.Cmax) / parseFloat(ref.Cmax) * 100).toFixed(0);
                                const aucR = (parseFloat(c.pkResult.params.AUC) / parseFloat(ref.AUC) * 100).toFixed(0);
                                const fR = (parseFloat(c.pkResult.params.F) / parseFloat(ref.F) * 100).toFixed(0);
                                
                                let interpretation = '';
                                if (idx > 0) {
                                    if (aucR > 150) interpretation = '<span class="badge badge-green">ë§¤ìš° ìš°ìˆ˜</span>';
                                    else if (aucR > 120) interpretation = '<span class="badge badge-green">ìš°ìˆ˜</span>';
                                    else if (aucR >= 80) interpretation = '<span class="badge badge-blue">ìœ ì‚¬</span>';
                                    else if (aucR >= 50) interpretation = '<span class="badge" style="background: #fef3c7; color: #92400e;">ë³´í†µ</span>';
                                    else interpretation = '<span class="badge badge-red">ë‚®ìŒ</span>';
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${c.name}</strong></td>
                                        <td>${idx === 0 ? '<strong>100% (ê¸°ì¤€)</strong>' : cmaxR + '%'}</td>
                                        <td>${idx === 0 ? '<strong>100% (ê¸°ì¤€)</strong>' : aucR + '%'}</td>
                                        <td>${idx === 0 ? '<strong>100% (ê¸°ì¤€)</strong>' : fR + '%'}</td>
                                        <td>${idx === 0 ? '-' : interpretation}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                <div class="alert alert-warning">
                    <strong>âš ï¸ ëª¨ë¸ ì ìš© ë²”ìœ„ ë° í•œê³„</strong><br>
                    â€¢ <strong>ì ìš© ê°€ëŠ¥ ë²”ìœ„:</strong> ì¼ë°˜ì ì¸ ê²½êµ¬ ì•½ë¬¼ (LogP: -2~6, MW: 150-800)<br>
                    â€¢ <strong>ì •í™•ë„ ë†’ì€ ê²½ìš°:</strong> BCS Class I, II, III ì•½ë¬¼<br>
                    â€¢ <strong>ì˜ˆì¸¡ ì–´ë ¤ìš´ ê²½ìš°:</strong> ê·¹ì§€ì§ˆì„± (LogP > 6), ì´ˆì¥ê¸° ë°˜ê°ê¸° (>100h), íŠ¹ìˆ˜ íŠ¸ëœìŠ¤í¬í„° ì˜ì¡´ì„±<br>
                    â€¢ ì‹¤ì œ PKëŠ” ì¥ë‚´ëŒ€ì‚¬, ë‹´ì¦™ë°°ì„¤, ìŒì‹íš¨ê³¼, ì•½ë¬¼ìƒí˜¸ì‘ìš© ë“±ì˜ ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤<br>
                    â€¢ <strong>ë” ì •í™•í•œ ì˜ˆì¸¡ì„ ìœ„í•´ ì‹¤ì œ PK ë°ì´í„°ë¡œ ëª¨ë¸ ë³´ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤</strong>
                </div>

                <div class="info-box">
                    <strong>ğŸ“Œ ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒ íŒ</strong><br>
                    âœ“ Caco-2 ë˜ëŠ” BCS Class ì…ë ¥ìœ¼ë¡œ íˆ¬ê³¼ì„± ë°˜ì˜<br>
                    âœ“ ê°„ í´ë¦¬ì–´ëŸ°ìŠ¤ ì…ë ¥ ì‹œ ì´ˆíšŒí†µê³¼íš¨ê³¼ê°€ ì •í™•í•´ì§‘ë‹ˆë‹¤<br>
                    âœ“ ë‹¨ë°±ê²°í•©ë¥  ì…ë ¥ ì‹œ ë¶„í¬ìš©ì (Vd) ê³„ì‚°ì´ ê°œì„ ë©ë‹ˆë‹¤<br>
                    âœ“ ì…ìí¬ê¸° ì…ë ¥ ì‹œ dissolution rateê°€ Noyes-Whitney ì‹ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤
                </div>

                <div class="flex-between" style="margin-top: 20px;">
                    <button class="btn" onclick="currentStep=1; render();" 
                            style="background: #6b7280; color: white; width: 32%;">
                        ğŸ”„ ì²˜ìŒìœ¼ë¡œ
                    </button>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="width: 32%;">
                        ğŸ’¾ CSV ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button class="btn btn-primary" onclick="window.print()" style="width: 32%;">
                        ğŸ–¨ï¸ ë³´ê³ ì„œ ì¶œë ¥
                    </button>
                </div>
            `;
        }

        function renderChart() {
            const ctx = document.getElementById('pkChart');
            if (!ctx) return;
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return;

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: calc[0].pkResult.profile.map(p => p.time.toFixed(1)),
                    datasets: calc.map(c => ({
                        label: `${c.name} (${c.route})`,
                        data: c.pkResult.profile.map(p => p.concentration),
                        borderColor: c.color,
                        backgroundColor: c.color + '20',
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 12, weight: '600' } } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' ng/mL'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (hours)', font: { size: 13, weight: '600' } },
                            ticks: { maxTicksLimit: 13 }
                        },
                        y: {
                            title: { display: true, text: 'Concentration (ng/mL)', font: { size: 13, weight: '600' } },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function exportCSV() {
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return;

            let csv = 'Time (h),' + calc.map(c => c.name).join(',') + '\n';
            for (let i = 0; i < calc[0].pkResult.profile.length; i++) {
                const time = calc[0].pkResult.profile[i].time.toFixed(1);
                const values = calc.map(c => c.pkResult.profile[i].concentration.toFixed(4));
                csv += time + ',' + values.join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `pk_prediction_${selectedSpecies}_${Date.now()}.csv`;
            link.click();
        }

        function render() {
            updateStepIndicator();
            const content = document.getElementById('main-content');
            
            if (currentStep === 1) content.innerHTML = renderStep1();
            else if (currentStep === 2) content.innerHTML = renderStep2();
            else content.innerHTML = renderStep3();

            if (currentStep === 3) setTimeout(renderChart, 100);
        }

        // ì´ˆê¸°í™” ì‹œ ì²« ë²ˆì§¸ ë¬¼ì§ˆ ìë™ ì¶”ê°€
        addCompound();
        render();
    </script>
</body>
</html>
