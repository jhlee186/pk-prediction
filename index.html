<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .tabs { display: flex; border-bottom: 2px solid #e5e7eb; background: white; }
        .tab { padding: 16px 24px; cursor: pointer; border: none; background: none; font-size: 15px; font-weight: 500; color: #6b7280; transition: all 0.3s; }
        .tab:hover { color: #4f46e5; }
        .tab.active { color: #4f46e5; border-bottom: 3px solid #4f46e5; }
        .content { padding: 30px; }
        .section { background: #f9fafb; padding: 24px; border-radius: 8px; margin-bottom: 20px; }
        .section h2 { font-size: 18px; margin-bottom: 16px; color: #1f2937; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .alert { padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid; }
        .alert-error { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .alert-warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
        .compound-item { background: white; padding: 20px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 16px; }
        .compound-item.selected { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .compound-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .compound-header h3 { color: #1f2937; font-size: 16px; }
        .chart-container { height: 450px; margin-top: 20px; }
        .comparison-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .comparison-table th, .comparison-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .comparison-table th { background: #f9fafb; font-weight: 600; color: #374151; }
        .comparison-table tr:hover { background: #f9fafb; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .color-indicator { width: 20px; height: 20px; border-radius: 4px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ§¬ In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ë° ë¹„êµ ì‹œìŠ¤í…œ</h1>
                <p>ì‹ ì•½ DS ë¬¼ì§ˆ ë° Salt Form ê°„ ì•½ë™í•™ ë¹„êµ ë¶„ì„</p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('compounds')">ğŸ“Š ë¬¼ì§ˆ ê´€ë¦¬</button>
                <button class="tab" onclick="switchTab('species')">ğŸ¾ ì¢… ì„¤ì •</button>
                <button class="tab" onclick="switchTab('comparison')">ğŸ“ˆ ë¹„êµ ë¶„ì„</button>
            </div>

            <div class="content">
                <div id="alerts"></div>
                <div id="tab-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'compounds';
        let compounds = [];
        let selectedSpecies = 'rat';
        let speciesSettings = {
            rat: { bodyWeight: 0.25, Vd: 3.5, CL: 50, ka: 1.2, label: 'ğŸ€ Rat' },
            mouse: { bodyWeight: 0.025, Vd: 4.0, CL: 60, ka: 1.5, label: 'ğŸ­ Mouse' },
            dog: { bodyWeight: 10, Vd: 2.0, CL: 25, ka: 0.8, label: 'ğŸ• Dog' }
        };
        let chartInstance = null;
        let alerts = [];

        const formulationDatabase = {
            'water': { label: 'ì •ì œìˆ˜', viscosity: 1, solubilityFactor: 1.0 },
            '0.5% MC': { label: '0.5% MC', viscosity: 50, solubilityFactor: 1.2 },
            '0.5% MC 4000cP': { label: '0.5% MC (4000 cP)', viscosity: 4000, solubilityFactor: 1.3 },
            '0.2% Tween80 in 0.5% MC': { label: '0.2% Tween 80 in 0.5% MC', viscosity: 3800, solubilityFactor: 2.5 },
            '0.5% CMC': { label: '0.5% CMC', viscosity: 100, solubilityFactor: 1.4 },
            '1% Tween80': { label: '1% Tween 80', viscosity: 5, solubilityFactor: 3.0 },
            'PEG400 30%': { label: '30% PEG 400', viscosity: 50, solubilityFactor: 4.0 }
        };

        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

        function addAlert(type, message) {
            alerts.push({ type, message });
            renderAlerts();
        }

        function clearAlerts() {
            alerts = [];
            renderAlerts();
        }

        function renderAlerts() {
            const container = document.getElementById('alerts');
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = alerts.map(a => 
                `<div class="alert alert-${a.type}">${a.message}</div>`
            ).join('');
        }

        function addCompound() {
            const id = Date.now();
            compounds.push({
                id,
                name: `ë¬¼ì§ˆ ${compounds.length + 1}`,
                solubility: { pH1_2: '', pH4_5: '', pH6_8: '', faSSIF: '', faSSGF: '', feSSIF: '', water: '' },
                properties: {
                    molecularWeight: '', logP: '', pKa: '', dose: '',
                    proteinBinding: '95', permeability: 'high', formulationBase: 'water'
                },
                pkResult: null,
                color: colors[compounds.length % colors.length]
            });
            render();
        }

        function removeCompound(id) {
            compounds = compounds.filter(c => c.id !== id);
            render();
        }

        function updateCompound(id, field, subfield, value) {
            const compound = compounds.find(c => c.id === id);
            if (!compound) return;
            
            if (subfield) {
                compound[field][subfield] = value;
            } else {
                compound[field] = value;
            }
        }

        function calculatePK(compound) {
            clearAlerts();
            
            // ê²€ì¦
            const sol = Object.values(compound.solubility).filter(v => v !== '').map(v => parseFloat(v));
            if (sol.length === 0) {
                addAlert('error', `${compound.name}: ìµœì†Œ 1ê°œ ì´ìƒì˜ ìš©í•´ë„ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                return false;
            }
            if (!compound.properties.molecularWeight || !compound.properties.dose) {
                addAlert('error', `${compound.name}: ë¶„ìëŸ‰ê³¼ íˆ¬ì—¬ ìš©ëŸ‰ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
                return false;
            }

            const species = selectedSpecies;
            const settings = speciesSettings[species];
            const formEffect = formulationDatabase[compound.properties.formulationBase];
            
            // ìš©í•´ë„ ê³„ì‚°
            const gastricSol = (parseFloat(compound.solubility.faSSGF || compound.solubility.pH1_2) || 0.01) * formEffect.solubilityFactor;
            const intestinalSol = (parseFloat(compound.solubility.faSSIF || compound.solubility.pH6_8) || 0.01) * formEffect.solubilityFactor;
            
            // í¡ìˆ˜ìœ¨ ê³„ì‚°
            const logP = parseFloat(compound.properties.logP) || 2;
            const mw = parseFloat(compound.properties.molecularWeight);
            let permFactor = 0.9;
            if (compound.properties.permeability === 'medium') permFactor = 0.6;
            else if (compound.properties.permeability === 'low') permFactor = 0.3;
            
            const solLimited = Math.min(1, (intestinalSol * 10) / (mw * 0.01));
            const Fa = Math.min(0.95, solLimited * permFactor);
            
            // PK ê³„ì‚°
            const dose = parseFloat(compound.properties.dose);
            const Vd = settings.Vd * (1 + logP * 0.3);
            const CL = settings.CL * (400 / mw) * 0.8;
            const viscosityDelay = Math.log10(formEffect.viscosity) * 0.1;
            const ka = settings.ka / (1 + viscosityDelay);
            const ke = (CL * 60) / (Vd * 1000);
            
            const timePoints = [];
            for (let t = 0; t <= 24; t += 0.5) {
                const conc = (Fa * dose * 1000 / (Vd * settings.bodyWeight)) * 
                             (ka / (ka - ke)) * 
                             (Math.exp(-ke * t) - Math.exp(-ka * t));
                timePoints.push({ time: t, concentration: Math.max(0, conc) });
            }
            
            let auc = 0;
            for (let i = 1; i < timePoints.length; i++) {
                auc += (timePoints[i].concentration + timePoints[i-1].concentration) / 2 * 0.5;
            }
            
            const Cmax = Math.max(...timePoints.map(p => p.concentration));
            const Tmax = timePoints.find(p => p.concentration === Cmax)?.time || 0;
            
            compound.pkResult = {
                profile: timePoints,
                params: {
                    Cmax: Cmax.toFixed(2),
                    Tmax: Tmax.toFixed(1),
                    AUC: auc.toFixed(2),
                    Vd: Vd.toFixed(2),
                    CL: CL.toFixed(2),
                    t_half: (0.693 / ke).toFixed(2),
                    Fa: (Fa * 100).toFixed(1)
                }
            };
            
            return true;
        }

        function calculateAll() {
            clearAlerts();
            let success = true;
            for (let compound of compounds) {
                if (!calculatePK(compound)) success = false;
            }
            if (success && compounds.length > 0) {
                addAlert('info', 'âœ… ëª¨ë“  ë¬¼ì§ˆì˜ PK ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. "ë¹„êµ ë¶„ì„" íƒ­ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                setTimeout(() => switchTab('comparison'), 1500);
            }
        }

        function renderCompoundsTab() {
            return `
                <div>
                    <div class="flex-between" style="margin-bottom: 20px;">
                        <h2>ë“±ë¡ëœ ë¬¼ì§ˆ: ${compounds.length}ê°œ</h2>
                        <button class="btn btn-secondary" onclick="addCompound()">â• ìƒˆ ë¬¼ì§ˆ ì¶”ê°€</button>
                    </div>

                    ${compounds.length === 0 ? '<div class="alert alert-info">ë¬¼ì§ˆì„ ì¶”ê°€í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.</div>' : ''}

                    ${compounds.map(c => `
                        <div class="compound-item">
                            <div class="compound-header">
                                <div class="flex-between" style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="color-indicator" style="background: ${c.color};"></div>
                                        <input type="text" value="${c.name}" 
                                               onchange="updateCompound(${c.id}, 'name', null, this.value); render();"
                                               style="font-size: 16px; font-weight: 600; border: 1px solid #e5e7eb; padding: 6px 12px; border-radius: 6px;">
                                    </div>
                                    <button class="btn btn-danger" onclick="removeCompound(${c.id}); render();">ğŸ—‘ï¸ ì‚­ì œ</button>
                                </div>
                            </div>

                            <div class="section">
                                <h3 style="font-size: 15px; margin-bottom: 12px;">ğŸ“Š In Vitro ìš©í•´ë„ (Î¼g/mL)</h3>
                                <div class="grid">
                                    ${['pH1_2', 'pH4_5', 'pH6_8', 'faSSIF', 'faSSGF', 'feSSIF', 'water'].map(key => {
                                        const labels = {
                                            pH1_2: 'pH 1.2', pH4_5: 'pH 4.5', pH6_8: 'pH 6.8',
                                            faSSIF: 'FaSSIF', faSSGF: 'FaSSGF', feSSIF: 'FeSSIF', water: 'ì •ì œìˆ˜'
                                        };
                                        return `
                                            <div class="form-group">
                                                <label>${labels[key]}</label>
                                                <input type="number" step="0.01" value="${c.solubility[key]}"
                                                       onchange="updateCompound(${c.id}, 'solubility', '${key}', this.value)">
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <div class="section">
                                <h3 style="font-size: 15px; margin-bottom: 12px;">âš—ï¸ ë¬¼ë¦¬í™”í•™ì  íŠ¹ì„±</h3>
                                <div class="grid">
                                    <div class="form-group">
                                        <label>ë¶„ìëŸ‰ (MW) *</label>
                                        <input type="number" value="${c.properties.molecularWeight}"
                                               onchange="updateCompound(${c.id}, 'properties', 'molecularWeight', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>LogP</label>
                                        <input type="number" step="0.1" value="${c.properties.logP}"
                                               onchange="updateCompound(${c.id}, 'properties', 'logP', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>pKa</label>
                                        <input type="number" step="0.1" value="${c.properties.pKa}"
                                               onchange="updateCompound(${c.id}, 'properties', 'pKa', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>íˆ¬ì—¬ ìš©ëŸ‰ (mg/kg) *</label>
                                        <input type="number" value="${c.properties.dose}"
                                               onchange="updateCompound(${c.id}, 'properties', 'dose', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>ì¥ íˆ¬ê³¼ë„</label>
                                        <select value="${c.properties.permeability}"
                                                onchange="updateCompound(${c.id}, 'properties', 'permeability', this.value)">
                                            <option value="high">High</option>
                                            <option value="medium">Medium</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>ë¶€í˜•ì œ</label>
                                        <select value="${c.properties.formulationBase}"
                                                onchange="updateCompound(${c.id}, 'properties', 'formulationBase', this.value)">
                                            ${Object.entries(formulationDatabase).map(([k, v]) => 
                                                `<option value="${k}">${v.label}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}

                    ${compounds.length > 0 ? `
                        <button class="btn btn-primary" onclick="calculateAll()" style="margin-top: 20px;">
                            ğŸš€ ì „ì²´ ë¬¼ì§ˆ PK ê³„ì‚° ë° ë¹„êµ ë¶„ì„
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function renderSpeciesTab() {
            return `
                <div>
                    <div class="alert alert-info">
                        ğŸ’¡ ë¹„êµ ë¶„ì„ì— ì‚¬ìš©í•  ë™ë¬¼ ì¢…ì„ ì„ íƒí•˜ê³ , í•„ìš”ì‹œ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°ì •í•˜ì„¸ìš”.
                    </div>

                    <div class="section">
                        <h2>ì‹¤í—˜ ë™ë¬¼ ì¢… ì„ íƒ</h2>
                        <div style="display: flex; gap: 16px; margin-top: 16px;">
                            ${Object.entries(speciesSettings).map(([key, s]) => `
                                <label style="flex: 1; cursor: pointer;">
                                    <div class="compound-item ${selectedSpecies === key ? 'selected' : ''}" 
                                         onclick="selectedSpecies='${key}'; render();">
                                        <h3 style="font-size: 18px; margin-bottom: 8px;">${s.label}</h3>
                                        <div style="font-size: 13px; color: #6b7280;">
                                            ì²´ì¤‘: ${s.bodyWeight} kg<br>
                                            Vd: ${s.Vd} L/kg<br>
                                            CL: ${s.CL} mL/min/kg
                                        </div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="section">
                        <h2>ì„ íƒëœ ì¢…: ${speciesSettings[selectedSpecies].label}</h2>
                        <div class="grid">
                            <div class="form-group">
                                <label>ì²´ì¤‘ (kg)</label>
                                <input type="number" step="0.001" value="${speciesSettings[selectedSpecies].bodyWeight}"
                                       onchange="speciesSettings['${selectedSpecies}'].bodyWeight = parseFloat(this.value)">
                            </div>
                            <div class="form-group">
                                <label>ë¶„í¬ìš©ì  Vd (L/kg)</label>
                                <input type="number" step="0.1" value="${speciesSettings[selectedSpecies].Vd}"
                                       onchange="speciesSettings['${selectedSpecies}'].Vd = parseFloat(this.value)">
                            </div>
                            <div class="form-group">
                                <label>í´ë¦¬ì–´ëŸ°ìŠ¤ CL (mL/min/kg)</label>
                                <input type="number" step="1" value="${speciesSettings[selectedSpecies].CL}"
                                       onchange="speciesSettings['${selectedSpecies}'].CL = parseFloat(this.value)">
                            </div>
                            <div class="form-group">
                                <label>í¡ìˆ˜ì†ë„ìƒìˆ˜ ka (1/h)</label>
                                <input type="number" step="0.1" value="${speciesSettings[selectedSpecies].ka}"
                                       onchange="speciesSettings['${selectedSpecies}'].ka = parseFloat(this.value)">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderComparisonTab() {
            const calculated = compounds.filter(c => c.pkResult);
            
            if (calculated.length === 0) {
                return `
                    <div class="alert alert-warning">
                        âš ï¸ ë¨¼ì € "ë¬¼ì§ˆ ê´€ë¦¬" íƒ­ì—ì„œ ë¬¼ì§ˆì„ ì¶”ê°€í•˜ê³  PK ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.
                    </div>
                `;
            }

            return `
                <div>
                    <div class="section">
                        <h2>ğŸ“ˆ ${speciesSettings[selectedSpecies].label} PK í”„ë¡œíŒŒì¼ ë¹„êµ</h2>
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>

                    <div class="section">
                        <h2>ğŸ“Š PK íŒŒë¼ë¯¸í„° ë¹„êµí‘œ</h2>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>ë¬¼ì§ˆëª…</th>
                                    <th>C<sub>max</sub> (ng/mL)</th>
                                    <th>T<sub>max</sub> (h)</th>
                                    <th>AUC (ngÂ·h/mL)</th>
                                    <th>t<sub>Â½</sub> (h)</th>
                                    <th>í¡ìˆ˜ìœ¨ (%)</th>
                                    <th>ë¶€í˜•ì œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${calculated.map(c => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div class="color-indicator" style="background: ${c.color};"></div>
                                                <strong>${c.name}</strong>
                                            </div>
                                        </td>
                                        <td><span class="badge badge-blue">${c.pkResult.params.Cmax}</span></td>
                                        <td>${c.pkResult.params.Tmax}</td>
                                        <td><span class="badge badge-green">${c.pkResult.params.AUC}</span></td>
                                        <td>${c.pkResult.params.t_half}</td>
                                        <td><span class="badge badge-purple">${c.pkResult.params.Fa}</span></td>
                                        <td>${formulationDatabase[c.properties.formulationBase].label}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${calculated.length > 1 ? `
                    <div class="section">
                        <h2>ğŸ”¬ ìƒëŒ€ ë¹„êµ (ê¸°ì¤€: ${calculated[0].name})</h2>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>ë¬¼ì§ˆëª…</th>
                                    <th>C<sub>max</sub> ë¹„ìœ¨</th>
                                    <th>AUC ë¹„ìœ¨</th>
                                    <th>í¡ìˆ˜ìœ¨ ë¹„ìœ¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${calculated.map((c, idx) => {
                                    const ref = calculated[0].pkResult.params;
                                    const cmaxRatio = (parseFloat(c.pkResult.params.Cmax) / parseFloat(ref.Cmax) * 100).toFixed(1);
                                    const aucRatio = (parseFloat(c.pkResult.params.AUC) / parseFloat(ref.AUC) * 100).toFixed(1);
                                    const faRatio = (parseFloat(c.pkResult.params.Fa) / parseFloat(ref.Fa) * 100).toFixed(1);
                                    return `
                                        <tr>
                                            <td><strong>${c.name}</strong></td>
                                            <td>${idx === 0 ? '100 (ê¸°ì¤€)' : cmaxRatio + '%'}</td>
                                            <td>${idx === 0 ? '100 (ê¸°ì¤€)' : aucRatio + '%'}</td>
                                            <td>${idx === 0 ? '100 (ê¸°ì¤€)' : faRatio + '%'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <div class="flex-between" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="exportCSV()">ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (CSV)</button>
                        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ ë³´ê³ ì„œ ì¶œë ¥</button>
                    </div>
                </div>
            `;
        }

        function renderChart() {
            const ctx = document.getElementById('comparisonChart');
            if (!ctx) return;

            const calculated = compounds.filter(c => c.pkResult);
            if (calculated.length === 0) return;

            if (chartInstance) chartInstance.destroy();

            const datasets = calculated.map(c => ({
                label: c.name,
                data: c.pkResult.profile.map(p => p.concentration),
                borderColor: c.color,
                backgroundColor: c.color + '20',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 0
            }));

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: calculated[0].pkResult.profile.map(p => p.time.toFixed(1)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 14, weight: '600' } } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' ng/mL'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time (hours)', font: { size: 14, weight: '600' } },
                            ticks: { maxTicksLimit: 13 }
                        },
                        y: {
                            title: { display: true, text: 'Concentration (ng/mL)', font: { size: 14, weight: '600' } },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function exportCSV() {
            const calculated = compounds.filter(c => c.pkResult);
            if (calculated.length === 0) return;

            let csv = 'Time (h),' + calculated.map(c => c.name).join(',') + '\n';
            
            for (let i = 0; i < calculated[0].pkResult.profile.length; i++) {
                const time = calculated[0].pkResult.profile[i].time.toFixed(1);
                const values = calculated.map(c => c.pkResult.profile[i].concentration.toFixed(4));
                csv += time + ',' + values.join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `pk_comparison_${selectedSpecies}_${Date.now()}.csv`;
            link.click();
        }

        function switchTab(tab) {
            clearAlerts();
            currentTab = tab;
            render();
            if (tab === 'comparison') {
                setTimeout(renderChart, 100);
            }
        }

        function render() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[
                currentTab === 'compounds' ? 0 : currentTab === 'species' ? 1 : 2
            ].classList.add('active');

            const content = document.getElementById('tab-content');
            if (currentTab === 'compounds') content.innerHTML = renderCompoundsTab();
            else if (currentTab === 'species') content.innerHTML = renderSpeciesTab();
            else content.innerHTML = renderComparisonTab();

            if (currentTab === 'comparison') {
                setTimeout(renderChart, 100);
            }
        }

        render();
    </script>
</body>
</html>