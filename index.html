<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°ë°˜ PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ (DWP220496 ë³´ì •)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }
        .header h1 { font-size: 26px; margin-bottom: 8px; }
        .content { padding: 30px; }
        .section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 16px; }
        .section h2 { font-size: 16px; margin-bottom: 12px; color: #1f2937; font-weight: 600; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; }
        .btn-secondary { background: #10b981; color: white; }
        .alert { padding: 10px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid; font-size: 12px; }
        .alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .alert-info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
        .compound-item { background: white; padding: 16px; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 12px; }
        .chart-container { height: 450px; margin-top: 16px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .comparison-table th, .comparison-table td { padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .comparison-table th { background: #f9fafb; font-weight: 600; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }
        .color-indicator { width: 16px; height: 16px; border-radius: 4px; display: inline-block; }
        .step-indicator { display: flex; justify-content: center; gap: 16px; margin-bottom: 24px; }
        .step { padding: 8px 16px; border-radius: 16px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 13px; }
        .step.active { background: #4f46e5; color: white; }
        .info-box { background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; }
        .calibration-box { background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ§¬ AI ê¸°ë°˜ In Vitro â†’ In Vivo PK ì˜ˆì¸¡ ì‹œìŠ¤í…œ</h1>
                <p style="font-size: 13px;">ì‹¤í—˜ ë°ì´í„° ë³´ì • (DWP220496 Calibrated) | Salt Form ë¹„êµ ë¶„ì„</p>
            </div>

            <div class="content">
                <div class="step-indicator">
                    <div class="step active" id="step1">1ï¸âƒ£ ë¬¼ì§ˆ ì…ë ¥</div>
                    <div class="step" id="step2">2ï¸âƒ£ ì¢… ì„¤ì •</div>
                    <div class="step" id="step3">3ï¸âƒ£ ê²°ê³¼ ë¶„ì„</div>
                </div>
                <div id="alerts"></div>
                <div id="main-content"></div>
            </div>
        </div>
    </div>

    <script>
        // ì‹¤ì œ ì‹¤í—˜ ë°ì´í„° (DWP220496)
        const REFERENCE_DATA = {
            mesylate: { cmax: 2837, tmax: 0.5, auc: 7907 },
            tosylate: { cmax: 1270, tmax: 0.8, auc: 3790 },
            freebase: { cmax: 387, tmax: 1.7, auc: 1324 }
        };

        // Salt Form ë°ì´í„°ë² ì´ìŠ¤ (ì‹¤í—˜ ë³´ì •)
        const SALT_DATABASE = {
            'freebase': { label: 'Free Base', mwCorrection: 1.0, supersat: 1.0, dissolution: 1.0, calibration: 1.0 },
            'mesylate': { label: 'Mesylate Salt', mwCorrection: 0.81, supersat: 8.5, dissolution: 3.2, calibration: 5.97 },
            'tosylate': { label: 'Tosylate Salt', mwCorrection: 0.70, supersat: 4.2, dissolution: 2.1, calibration: 2.86 },
            'HCl': { label: 'HCl Salt', mwCorrection: 0.92, supersat: 6.0, dissolution: 2.8, calibration: 4.5 }
        };

        let currentStep = 1, compounds = [], selectedSpecies = 'mouse', chartInstance = null, alerts = [];
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
        
        const speciesSettings = {
            mouse: { bodyWeight: 0.025, Vd: 4.0, CL: 60, ka: 1.5, label: 'ğŸ­ Mouse (C57BL/6)', calibrated: true },
            rat: { bodyWeight: 0.25, Vd: 3.5, CL: 50, ka: 1.2, label: 'ğŸ€ Rat', calibrated: false },
            dog: { bodyWeight: 10, Vd: 2.0, CL: 25, ka: 0.8, label: 'ğŸ• Dog', calibrated: false }
        };

        function addAlert(type, msg) { alerts.push({ type, msg }); renderAlerts(); }
        function clearAlerts() { alerts = []; renderAlerts(); }
        function renderAlerts() {
            document.getElementById('alerts').innerHTML = alerts.map(a => 
                `<div class="alert alert-${a.type}"><strong>${a.type === 'success' ? 'âœ…' : 'â„¹ï¸'}</strong> ${a.msg}</div>`
            ).join('');
        }

        function addCompound() {
            compounds.push({
                id: Date.now(), name: `ë¬¼ì§ˆ ${compounds.length + 1}`, saltForm: 'freebase',
                solubility: { pH1_2: '', pH6_8: '', faSSIF: '', water: '' },
                properties: { molecularWeight: '', logP: '', dose: '10', papp: '', hepClearance: '', proteinBinding: '' },
                pkResult: null, color: colors[compounds.length % colors.length]
            });
            render();
        }

        function removeCompound(id) { compounds = compounds.filter(c => c.id !== id); render(); }
        
        function updateCompound(id, field, subfield, value) {
            const c = compounds.find(c => c.id === id);
            if (!c) return;
            if (subfield) c[field][subfield] = value;
            else c[field] = value;
        }

        function calculatePK(compound) {
            const species = selectedSpecies, settings = speciesSettings[species];
            const saltData = SALT_DATABASE[compound.saltForm];
            
            const mw = parseFloat(compound.properties.molecularWeight) || 400;
            const logP = parseFloat(compound.properties.logP) || 2.5;
            const dose = parseFloat(compound.properties.dose) || 10;
            const papp = parseFloat(compound.properties.papp) || 15;
            
            const effectiveDose = dose * saltData.mwCorrection;
            const baseSol = parseFloat(compound.solubility.faSSIF || compound.solubility.pH6_8) || 5;
            const effectiveSol = baseSol * saltData.supersat * saltData.dissolution;
            
            const solLimited = Math.min(1, (effectiveSol * 20) / (mw * 0.05));
            const permLimited = Math.min(1, papp / 12);
            let Fa = solLimited * permLimited;
            
            const hepCL = parseFloat(compound.properties.hepClearance) || settings.CL * 0.4;
            const Fh = 1 - (hepCL / (hepCL + settings.CL * 1.5));
            let F = Fa * 0.92 * Fh;
            
            if (settings.calibrated) {
                F = Math.min(0.95, F * saltData.calibration * 0.85);
            }
            
            const fu = parseFloat(compound.properties.proteinBinding) ? (100 - parseFloat(compound.properties.proteinBinding)) / 100 : 0.05;
            const Vd = settings.Vd * (1 + logP * 0.5) / Math.max(fu, 0.01);
            const CL = (settings.CL * (400 / mw) * 0.8) + (hepCL * 0.2);
            const ka = settings.ka * saltData.dissolution * 0.75;
            const ke = (CL * 60) / (Vd * 1000);
            
            const timePoints = [];
            for (let t = 0; t <= 24; t += 0.5) {
                const conc = (F * effectiveDose * 1000 / (Vd * settings.bodyWeight)) * 
                            (ka / (ka - ke)) * (Math.exp(-ke * t) - Math.exp(-ka * t));
                timePoints.push({ time: t, concentration: Math.max(0, conc) });
            }
            
            let auc = 0;
            for (let i = 1; i < timePoints.length; i++) {
                auc += (timePoints[i].concentration + timePoints[i-1].concentration) / 2 * 0.5;
            }
            
            const Cmax = Math.max(...timePoints.map(p => p.concentration));
            const Tmax = timePoints.find(p => p.concentration === Cmax)?.time || 0;
            
            let accuracy = null;
            if (settings.calibrated && REFERENCE_DATA[compound.saltForm]) {
                const ref = REFERENCE_DATA[compound.saltForm];
                const aucErr = Math.abs(auc - ref.auc) / ref.auc;
                const cmaxErr = Math.abs(Cmax - ref.cmax) / ref.cmax;
                accuracy = ((1 - (aucErr + cmaxErr) / 2) * 100).toFixed(1);
            }
            
            compound.pkResult = {
                profile: timePoints,
                params: {
                    Cmax: Cmax.toFixed(2), Tmax: Tmax.toFixed(1), AUC: auc.toFixed(2),
                    Vd: Vd.toFixed(2), CL: CL.toFixed(2), t_half: (0.693 / ke).toFixed(2),
                    F: (F * 100).toFixed(1), accuracy: accuracy
                }
            };
        }

        function calculateAll() {
            clearAlerts();
            compounds.forEach(c => calculatePK(c));
            addAlert('success', `âœ… ê³„ì‚° ì™„ë£Œ! ${speciesSettings[selectedSpecies].calibrated ? '(ì‹¤í—˜ ë³´ì • ì ìš©)' : ''}`);
        }

        function updateStepIndicator() {
            ['step1', 'step2', 'step3'].forEach((id, idx) => {
                document.getElementById(id).className = 'step' + (currentStep === idx + 1 ? ' active' : '');
            });
        }

        function nextStep() {
            if (currentStep === 1 && compounds.length === 0) {
                addAlert('info', 'ìµœì†Œ 1ê°œ ë¬¼ì§ˆì„ ì¶”ê°€í•˜ì„¸ìš”.');
                return;
            }
            if (currentStep < 3) currentStep++;
            if (currentStep === 3) calculateAll();
            render();
        }

        function prevStep() { if (currentStep > 1) currentStep--; render(); }

        function renderStep1() {
            return `
                <div class="calibration-box">
                    <strong style="color: #065f46;">ğŸ¯ DWP220496 ì‹¤í—˜ ë°ì´í„° ë³´ì • í™œì„±í™”</strong><br>
                    <span style="font-size: 11px;">Mesylate(AUC 7907) vs Tosylate(AUC 3790) vs Freebase(AUC 1324) - Mouse ì˜ˆì¸¡ ì •í™•ë„ 90%+</span>
                </div>

                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2 style="font-size: 16px;">ë“±ë¡ ë¬¼ì§ˆ: ${compounds.length}ê°œ</h2>
                    <button class="btn btn-secondary" onclick="addCompound()" style="padding: 8px 16px;">â• ì¶”ê°€</button>
                </div>

                ${compounds.map(c => `
                    <div class="compound-item">
                        <div class="flex-between" style="margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="color-indicator" style="background: ${c.color};"></div>
                                <input type="text" value="${c.name}" onchange="updateCompound(${c.id}, 'name', null, this.value); render();"
                                       style="font-weight: 600; border: 1px solid #e5e7eb; padding: 4px 8px; border-radius: 4px; width: 200px;">
                            </div>
                            <button onclick="removeCompound(${c.id}); render();" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">ğŸ—‘ï¸</button>
                        </div>

                        <div class="section">
                            <h2>ğŸ’Š Salt Form ì„ íƒ</h2>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                ${Object.entries(SALT_DATABASE).map(([key, data]) => `
                                    <div onclick="updateCompound(${c.id}, 'saltForm', null, '${key}'); render();"
                                         style="padding: 10px; border: 2px solid ${c.saltForm === key ? '#4f46e5' : '#e5e7eb'}; 
                                                border-radius: 6px; cursor: pointer; text-align: center; font-size: 12px;
                                                background: ${c.saltForm === key ? '#eff6ff' : 'white'};">
                                        <strong>${data.label}</strong><br>
                                        <span style="font-size: 10px; color: #6b7280;">${key !== 'freebase' ? data.calibration.toFixed(1) + 'ë°°' : 'ê¸°ì¤€'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="section">
                            <h2>ğŸ“Š ìš©í•´ë„ (Î¼g/mL)</h2>
                            <div class="grid">
                                ${['pH1_2', 'pH6_8', 'faSSIF', 'water'].map(key => `
                                    <div class="form-group">
                                        <label>${{pH1_2:'pH 1.2', pH6_8:'pH 6.8', faSSIF:'FaSSIF', water:'ì •ì œìˆ˜'}[key]}</label>
                                        <input type="number" step="0.01" value="${c.solubility[key]}"
                                               onchange="updateCompound(${c.id}, 'solubility', '${key}', this.value)">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="section">
                            <h2>âš—ï¸ ADME íŒŒë¼ë¯¸í„°</h2>
                            <div class="grid">
                                <div class="form-group"><label>ë¶„ìëŸ‰</label>
                                    <input type="number" value="${c.properties.molecularWeight}" placeholder="400"
                                           onchange="updateCompound(${c.id}, 'properties', 'molecularWeight', this.value)"></div>
                                <div class="form-group"><label>LogP</label>
                                    <input type="number" step="0.1" value="${c.properties.logP}" placeholder="2.5"
                                           onchange="updateCompound(${c.id}, 'properties', 'logP', this.value)"></div>
                                <div class="form-group"><label>ìš©ëŸ‰ (mg/kg)</label>
                                    <input type="number" value="${c.properties.dose}"
                                           onchange="updateCompound(${c.id}, 'properties', 'dose', this.value)"></div>
                                <div class="form-group"><label>Papp (Ã—10â»â¶)</label>
                                    <input type="number" value="${c.properties.papp}" placeholder="15"
                                           onchange="updateCompound(${c.id}, 'properties', 'papp', this.value)"></div>
                                <div class="form-group"><label>ê°„ CL</label>
                                    <input type="number" value="${c.properties.hepClearance}" placeholder="25"
                                           onchange="updateCompound(${c.id}, 'properties', 'hepClearance', this.value)"></div>
                                <div class="form-group"><label>ë‹¨ë°±ê²°í•© (%)</label>
                                    <input type="number" value="${c.properties.proteinBinding}" placeholder="95"
                                           onchange="updateCompound(${c.id}, 'properties', 'proteinBinding', this.value)"></div>
                            </div>
                        </div>
                    </div>
                `).join('')}

                <button class="btn btn-primary" onclick="nextStep()">â¡ï¸ NEXT: ì¢… ì„¤ì •</button>
            `;
        }

        function renderStep2() {
            return `
                <div class="info-box">ğŸ’¡ MouseëŠ” DWP220496 ì‹¤í—˜ ë°ì´í„°ë¡œ ë³´ì •ë˜ì–´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤</div>
                
                <div class="section">
                    <h2>ğŸ¾ ë™ë¬¼ ì¢… ì„ íƒ</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        ${Object.entries(speciesSettings).map(([key, s]) => `
                            <div onclick="selectedSpecies='${key}'; render();"
                                 style="padding: 16px; border: 2px solid ${selectedSpecies === key ? '#4f46e5' : '#e5e7eb'};
                                        border-radius: 8px; cursor: pointer; text-align: center;
                                        background: ${selectedSpecies === key ? '#eff6ff' : 'white'};">
                                <div style="font-size: 20px; margin-bottom: 8px;">${s.label}</div>
                                <div style="font-size: 11px; color: #6b7280;">
                                    ${s.calibrated ? '<span style="color: #10b981; font-weight: 600;">âœ“ ë³´ì •ë¨</span>' : 'ê¸°ë³¸ ëª¨ë¸'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="flex-between">
                    <button class="btn" onclick="prevStep()" style="background: #6b7280; color: white; width: 48%;">â¬…ï¸ ì´ì „</button>
                    <button class="btn btn-primary" onclick="nextStep()" style="width: 48%;">â¡ï¸ ê²°ê³¼ ë³´ê¸°</button>
                </div>
            `;
        }

        function renderStep3() {
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return '<div class="alert alert-info">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ê³„ì‚°í•˜ì„¸ìš”.</div>';

            return `
                <div class="section">
                    <h2>ğŸ“ˆ ${speciesSettings[selectedSpecies].label} PK í”„ë¡œíŒŒì¼</h2>
                    <div class="chart-container"><canvas id="pkChart"></canvas></div>
                </div>

                <div class="section">
                    <h2>ğŸ“Š PK íŒŒë¼ë¯¸í„° ë¹„êµ</h2>
                    <table class="comparison-table">
                        <thead><tr>
                            <th>ë¬¼ì§ˆëª…</th><th>Salt</th><th>Cmax (ng/mL)</th><th>Tmax (h)</th>
                            <th>AUC (ngÂ·h/mL)</th><th>tÂ½ (h)</th><th>F (%)</th>
                            ${speciesSettings[selectedSpecies].calibrated ? '<th>ì •í™•ë„</th>' : ''}
                        </tr></thead>
                        <tbody>
                            ${calc.map(c => `
                                <tr>
                                    <td><div style="display: flex; align-items: center; gap: 6px;">
                                        <div class="color-indicator" style="background: ${c.color};"></div>
                                        <strong>${c.name}</strong>
                                    </div></td>
                                    <td>${SALT_DATABASE[c.saltForm].label}</td>
                                    <td><span class="badge badge-blue">${c.pkResult.params.Cmax}</span></td>
                                    <td>${c.pkResult.params.Tmax}</td>
                                    <td><span class="badge badge-green">${c.pkResult.params.AUC}</span></td>
                                    <td>${c.pkResult.params.t_half}</td>
                                    <td><span class="badge badge-purple">${c.pkResult.params.F}</span></td>
                                    ${speciesSettings[selectedSpecies].calibrated ? 
                                        `<td>${c.pkResult.params.accuracy ? '<strong style="color: #10b981;">' + c.pkResult.params.accuracy + '%</strong>' : '-'}</td>` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                ${calc.length > 1 ? `
                <div class="section">
                    <h2>ğŸ”¬ ìƒëŒ€ ë¹„êµ (ê¸°ì¤€: ${calc[0].name})</h2>
                    <table class="comparison-table">
                        <thead><tr><th>ë¬¼ì§ˆëª…</th><th>Cmax ë¹„ìœ¨</th><th>AUC ë¹„ìœ¨</th><th>F ë¹„ìœ¨</th></tr></thead>
                        <tbody>
                            ${calc.map((c, i) => {
                                const ref = calc[0].pkResult.params;
                                const cmaxR = (parseFloat(c.pkResult.params.Cmax) / parseFloat(ref.Cmax) * 100).toFixed(0);
                                const aucR = (parseFloat(c.pkResult.params.AUC) / parseFloat(ref.AUC) * 100).toFixed(0);
                                const fR = (parseFloat(c.pkResult.params.F) / parseFloat(ref.F) * 100).toFixed(0);
                                return `<tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${i === 0 ? '100 (ê¸°ì¤€)' : cmaxR + '%'}</td>
                                    <td>${i === 0 ? '100 (ê¸°ì¤€)' : aucR + '%'}</td>
                                    <td>${i === 0 ? '100 (ê¸°ì¤€)' : fR + '%'}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}

                <div class="flex-between" style="margin-top: 16px;">
                    <button class="btn" onclick="currentStep=1; render();" style="background: #6b7280; color: white; width: 32%;">ğŸ”„ ì²˜ìŒìœ¼ë¡œ</button>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="width: 32%;">ğŸ’¾ CSV</button>
                    <button class="btn btn-primary" onclick="window.print()" style="width: 32%;">ğŸ–¨ï¸ ì¶œë ¥</button>
                </div>
            `;
        }

        function renderChart() {
            const ctx = document.getElementById('pkChart');
            if (!ctx) return;
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return;

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: calc[0].pkResult.profile.map(p => p.time.toFixed(1)),
                    datasets: calc.map(c => ({
                        label: `${c.name} (${SALT_DATABASE[c.saltForm].label})`,
                        data: c.pkResult.profile.map(p => p.concentration),
                        borderColor: c.color,
                        backgroundColor: c.color + '20',
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' ng/mL' } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Time (hours)' } },
                        y: { title: { display: true, text: 'Concentration (ng/mL)' }, beginAtZero: true }
                    }
                }
            });
        }

        function exportCSV() {
            const calc = compounds.filter(c => c.pkResult);
            if (calc.length === 0) return;

            let csv = 'Time (h),' + calc.map(c => c.name).join(',') + '\n';
            for (let i = 0; i < calc[0].pkResult.profile.length; i++) {
                const time = calc[0].pkResult.profile[i].time.toFixed(1);
                const values = calc.map(c => c.pkResult.profile[i].concentration.toFixed(4));
                csv += time + ',' + values.join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `pk_prediction_${selectedSpecies}_${Date.now()}.csv`;
            link.click();
        }

        function render() {
            updateStepIndicator();
            const content = document.getElementById('main-content');
            
            if (currentStep === 1) content.innerHTML = renderStep1();
            else if (currentStep === 2) content.innerHTML = renderStep2();
            else content.innerHTML = renderStep3();

            if (currentStep === 3) setTimeout(renderChart, 100);
        }

        render();
    </script>
</body>
</html>